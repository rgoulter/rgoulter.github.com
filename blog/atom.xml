<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Richard Goulter's Blog</title>
    <link href="http://www.rgoulter.com/blog//atom.xml" rel="self" />
    <link href="http://www.rgoulter.com/blog/" />
    <id>http://www.rgoulter.com/blog//atom.xml</id>
    <author>
        <name>Richard Goulter</name>
        
        <email>richard.goulter+blog@gmail.com</email>
        
    </author>
    <updated>2024-06-16T00:00:00Z</updated>
    <entry>
    <title>Using the QMK Leader Key for Fancy Keyboard Functionality</title>
    <link href="http://www.rgoulter.com/blog//posts/programming/2024-06-16-using-the-qmk-leader-key-for-fancy-keyboard-functionality.html" />
    <id>http://www.rgoulter.com/blog//posts/programming/2024-06-16-using-the-qmk-leader-key-for-fancy-keyboard-functionality.html</id>
    <published>2024-06-16T00:00:00Z</published>
    <updated>2024-06-16T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><a href="https://qmk.fm/">QMK</a> keyboards are keyboards where the functionality can be
customized.</p>
<p>Customising keyboard functionality goes hand in hand with non-traditional
keyboards, like ortholinear or split keyboards, which seek to improve upon the
traditional keyboard’s pretty awful design. (<a href="https://github.com/rgoulter/keyboard-labs">I’ve designed a few such
keyboards</a>).</p>
<p>There are some QMK features where it’s fairly clear how to make effective use of
the feature, such as <a href="https://docs.qmk.fm/feature_layers">layers</a>, <a href="https://docs.qmk.fm/tap_hold">tap
hold</a> or <a href="https://docs.qmk.fm/features/caps_word">caps
word</a>.</p>
<p>One feature that I had not found an effective use for was the <a href="https://docs.qmk.fm/features/leader_key">“leader
key”</a> feature. This feature
is named after Vim’s <a href="https://vimhelp.org/map.txt.html#%3CLeader%3E">leader
key</a>.</p>
<h2 id="vim-and-key-sequences">Vim and Key Sequences</h2>
<p>In vim, the leader key is a placeholder, and can be used for the start of <a href="https://vimhelp.org/map.txt.html#key-mapping">a
sequences of keys which maps to some
command</a>.</p>
<p>Generally, sequences of keys are fundamental to vim’s keybindings, especially for its
<a href="http://www.robertames.com/blog.cgi/entries/physics-of-vim.html">verb-motion
idiom</a>.<br />
e.g. the key sequence <code>d$</code> commands the editor to “delete until the end of
line”, or <code>yi"</code> commands the editor to yank (copy) the text inside the <code>"</code> marks
the cursor is inside of.</p>
<p>I first came across heavy use of the space-as-leader idiom in
<a href="https://www.spacemacs.org/">spacemacs</a>, which uses vim-keybindings, and space
as its leader key.</p>
<p>My main text editing environment is <a href="https://github.com/doomemacs/">Doom Emacs</a>,
which also uses space-as-leader for its command map.<br />
e.g. <code>spc t b</code> to Toggles the font to a Big size. <code>spc f s</code> Saves the File.</p>
<p>VSCode, to a lesser extent, also uses sequences in its keyboard shortcuts.<br />
e.g. Ctrl+K Ctrl+C adds a line comment.</p>
<p>In QMK, the leader key is used to start listening for a sequence of keypresses,
which can then be handled by custom functionality.</p>
<h2 id="typical-uses-of-the-qmk-leader-key">Typical Uses of the QMK Leader Key</h2>
<p>What to use QMK’s leader key for?</p>
<p>QMK’s <a href="https://docs.qmk.fm/features/leader_key">documentation for the leader
key</a> gives examples of sequences which
map to <code>SEND_STRING</code>. i.e. using it as a way to trigger macros.</p>
<p>I had previously tried that, but didn’t end up making much use of it.<br />
I reckon the effort to recognise I could use the leader sequence (&amp; recall how
to invoke it) was higher than just typing out my email or username or hostname
or whatever.</p>
<p>But also, I think there are other ways to avoid having to type the same thing
out frequently:<br />
On the command line, using fzf with shell history is a great way to find
previously typed commands, which is close enough to “save typing the same thing
out” for me; <a href="https://fishshell.com/docs/current/cmds/abbr.html">fish shell’s
abbr</a> seems a useful way of
“save typing the same thing out”. This is similar to typical shell aliases,
except it expands the abbreviation before executing it.</p>
<h2 id="another-idea-for-qmk-leader-key-sequences">Another Idea for QMK Leader Key Sequences</h2>
<p>Putting 2 and 2 together, I had another idea of what to use the QMK leader functionality for:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> leader_end_user<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_Q<span class="op">,</span> KC_B<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: QMK Boot</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        reset_keyboard<span class="op">();</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_C<span class="op">,</span> KC_C<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Caps DWIM (capslock)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        tap_code<span class="op">(</span>KC_CAPS<span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef CAPS_WORD_ENABLE</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_C<span class="op">,</span> KC_W<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Caps capsWord</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        caps_word_on<span class="op">();</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef HAPTIC_ENABLE</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_H<span class="op">,</span> KC_H<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Haptic DWIM (toggle)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      haptic_toggle<span class="op">();</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_H<span class="op">,</span> KC_E<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Haptic Enable</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      haptic_enable<span class="op">();</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_H<span class="op">,</span> KC_D<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Haptic Disable</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      haptic_disable<span class="op">();</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_K<span class="op">,</span> KC_K<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Keymap DWIM (set to default)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        default_layer_set_dvorak_keymap<span class="op">();</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_K<span class="op">,</span> KC_D<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Keymap Dvorak</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        default_layer_set_dvorak_keymap<span class="op">();</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_K<span class="op">,</span> KC_Q<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Keymap Qwerty</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        default_layer_set_qwerty_keymap<span class="op">();</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_K<span class="op">,</span> KC_G<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Keymap Gaming</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        default_layer_set_gaming_keymap<span class="op">();</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_K<span class="op">,</span> KC_H<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: Keymap Gaming (alt)</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        default_layer_set_gaming_alt_keymap<span class="op">();</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_O<span class="op">,</span> KC_W<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: OS Windows</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        current_os <span class="op">=</span> _OS_WIN<span class="op">;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_O<span class="op">,</span> KC_L<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: OS Linux</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        current_os <span class="op">=</span> _OS_LINUX<span class="op">;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_O<span class="op">,</span> KC_M<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: OS MacOS</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        current_os <span class="op">=</span> _OS_MACOS<span class="op">;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef RGB_MATRIX_ENABLE</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_R<span class="op">,</span> KC_R<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: RGB DWIM (next effect)</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        rgb_matrix_step_noeeprom<span class="op">();</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_R<span class="op">,</span> KC_J<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: RGB Jellybean</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        rgb_matrix_mode_noeeprom<span class="op">(</span>RGB_MATRIX_JELLYBEAN_RAINDROPS<span class="op">);</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_two_keys<span class="op">(</span>KC_R<span class="op">,</span> KC_T<span class="op">))</span> <span class="op">{</span> <span class="co">// mnemonic: RGB Toggle</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        rgb_matrix_toggle_noeeprom<span class="op">();</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>leader_sequence_one_key<span class="op">(</span>KC_L<span class="op">))</span> <span class="op">{</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="op">(</span>current_os<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _OS_LINUX<span class="op">:</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>                tap_code16<span class="op">(</span>CODE16_LINUX_DESKTOP_LOCK<span class="op">);</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _OS_MACOS<span class="op">:</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                tap_code16<span class="op">(</span>CODE16_MACOS_DESKTOP_LOCK<span class="op">);</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">case</span> _OS_WIN<span class="op">:</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>                tap_code16<span class="op">(</span>CODE16_WIN_DESKTOP_LOCK<span class="op">);</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span><span class="op">;</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    leader_end_keymap<span class="op">();</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This code implements the <code>leader_end_user</code> callback, which handles how QMK
leader key sequences behave for a keymap.</p>
<p>Example sequences:</p>
<ul>
<li><p><code>LEAD q b</code> enters the bootloader, which I hope to recall with “QMK -&gt; Bootloader”.</p></li>
<li><p><code>LEAD r t</code> toggles whether RGB lighting is on/off, which I hope to recall with
“RGB -&gt; Toggle”.</p></li>
</ul>
<p>“DWIM” means “Do What I Mean”.<br />
In this case, I mean “what’s the most common functionality to expect (from
tapping the same key twice)”.</p>
<p>More concretely, the idea is that QMK leader key sequences seem like a natural
interface for dynamic customisation of keyboard functionality.</p>
<p>I like the idea of allowing both the standard CapsLock and the fancier caps word
within the same keymap, but without needing to take the effort to remember which
key I put where.</p>
<p>I put my <code>leader_end_user</code> implementation in <a href="https://github.com/rgoulter/qmk_userspace">my
userspace</a>.</p>
<h2 id="downside-discoverability">Downside: Discoverability</h2>
<p>One obvious downside to this approach is that a keyboard’s firmware is not easily discoverable.</p>
<p>There’d be no easy way to discover what leader key sequences are implemented in a keymap.</p>
<p>Whereas, say, in VSCode, the keyboard shortcuts are shown as part of the command
palette.<br />
Or in Emacs, <a href="https://github.com/justbur/emacs-which-key">which-key</a> will
automatically show a map of keybindings (and the commands they’re bound to)
after pressing some key.<br />
e.g. pressing <code>spc f</code> presents a map of keybindings for next keys to press (such
as <code>s</code> to save file, <code>C</code> to copy the file, <code>D</code> to delete the file).</p>
<h2 id="similar-functionality-qmks-command">Similar Functionality: QMK’s Command</h2>
<p>The idea of using the keyboard to dynamically configure the keyboard
configuration is similar to what the <a href="https://docs.qmk.fm/features/command">Command
feature</a> does. – Except these commands
are invoked by holding down modifier keys, rather than by hitting a sequence of
keys.</p>
<p>The idea of using leader-key sequences for dynamically customising various
features is more general (&amp; implemented by the keymap, rather than as part of
QMK’s framework).</p>
<p>Incidentally, this Command feature has a “print help to the console” keybinding,
which is one way of addressing lack of discoverability.</p>
<h2 id="recall-cost-for-custom-and-small-keyboard-keymaps">Recall Cost for Custom and Small Keyboard Keymaps</h2>
<p>Maybe the idea of using leader key sequences seems complex; but I think it’s
worth comparing the above idea to other techniques used in keymap
implementations for custom (and small) keyboards:</p>
<p>Custom keyboards tend to have more functionality than just what the legends on
the keycaps denote.<br />
This means you have to remember anything that’s not on the keycaps.</p>
<p>Anything that’s frequently used will be easy to recall.<br />
What requires more consideration is trying to make recall easier for stuff
that’s used infrequently.</p>
<p>Small keyboards (like the ortholinear 4x12 keyboards, or split 36-key
keyboards) have keymaps which bring the full functionality of a typical keyboard
to within easy reach of the hands on home row.<br />
In my experience, it’s fairly straightforward to recall the “standard keyboard”
keys (letters, numbers, symbols), since it’s easy to position the keys in a way
that’s either familiar, or coherent.</p>
<p>e.g. The popular <a href="https://github.com/manna-harbour/miryoku/tree/master/docs/reference">Miryoku
keymap</a>
demonstrates a few techniques for how this is commonly achieved:</p>
<p>As an example of good key placement, where the positions are easy to recall: The
Number/Symbol layers are different than a traditional keyboard, but it’s
(mostly) coherent: the numbers resemble a numpad, the <code>[</code> key pairs with <code>]</code>.
<code>_</code> is often used as a placeholder for “space”.<br />
(I personally prefer to amend it by having <code>/</code> complement <code>\</code>, and by moving <code>~</code>
to home row’s pinkie finger).</p>
<p>Examples of how functionality is brought to within reach of the hands:</p>
<ul>
<li><p>Modifier keys Shift/Ctrl/Gui/Alt can be used with tap-hold using the keys on
home row. (“Home Row Mods”).</p></li>
<li><p>Miryoku puts the <code>CapsLock</code> key on a layer.</p></li>
<li><p>Miryoku has some “Additional Features”, such as switching between a Base and
an Extra keymap. These keys are on a layer, with additional intention gated
by requiring these keys to be tapped twice. (QMK’s <a href="https://docs.qmk.fm/features/tap_dance">tap
dance</a> feature).</p></li>
</ul>
<p>Putting the key on a layer comes with positional cost. – You have to be able to
recall <em>where</em> the key is. – And you have to recall which modifier keys to hold
down to activate the key. (Modifier-based shortcuts are more common than
sequence-based shortcuts. e.g. Ctrl+S for “save”, Ctrl+N for “new”. If you
squint, holding down Ctrl &amp; tapping S could be thought of as holding down a Fn
key, and hitting the “Save” key).</p>
<p>For “fancy keycodes” (keys that don’t appear on a typical keyboard), it can be
difficult to come up with ways to make it easy to remember its position.<br />
e.g. in the miryoku layout, it’s easier to recall where the arrow keys are
placed than where the “change RGB hue” key is. (The arrow keys are placed on
home row, or in a vi-style hjkl position).</p>
<p>Using QMK leader key sequences for “fancy keycodes” might be complex, but the
effort to remember the key sequence doesn’t rely on finding a position for it on
a layer, nor having to recall that position later.</p>
<h2 id="leader-key-sequence-cost-multiple-key-presses">Leader Key Sequence Cost: Multiple Key Presses</h2>
<p>Another obvious cost to using QMK leader sequences like suggested is the
sequence is not very quick to type out.</p>
<p>It involves pressing the <code>LEAD</code> key, and then some sequence of keys.<br />
That’s surely going to be slower than holding down some Fn keys and hitting a
single key.</p>
<p>This seems a reasonable trade-off to me: the cost of having to hit a sequence of
keys comes with the benefit that it’s easier to recall how to invoke it.</p>
<p>I’m optimistic that using leader key sequences are suitable for making it easier
to invoke behaviour that’s otherwise not frequently invoked enough to be easy to
position on a keyboard.</p>
<h2 id="leader-key-sequence-cost-firmware-size-and-complexity">Leader Key Sequence Cost: Firmware Size and Complexity</h2>
<p>I’m guessing a large number leader key sequences wouldn’t fit neatly on a
keyboard with a weak atmega32u4 MCU.</p>
<p>That’s probably another reason why getting an ARM-based custom keyboard. (Plugging again: <a href="https://github.com/rgoulter/keyboard-labs">I’ve designed a
few such keyboards</a>).</p>
<h2 id="other-possible-use-cases">Other Possible Use Cases</h2>
<p>Without having to worry about “where do I position these keys”, I reckon it’s
easier to add additional functionality to a keymap by adding a leader key
sequence which invokes it.</p>
<p>The point is less “it’s good to use leader key sequences for everything”, and
more “it’s a low cost to add it to the keymap, and will hopefully be easy to
recall if it’s needed”.</p>
<p>Here are some thoughts as to leader key sequences I think I might add to my
keymap:</p>
<ul>
<li><p>Toggle/Enable/Disable for various features.</p>
<ul>
<li>Rather than just having “RGB toggle” or “Haptics Enable”, it’d make sense to
provide all of “enable/disable/toggle” as part of leader key sequences.</li>
</ul></li>
<li><p>Dynamic Configuration: increase/decrease, default, min/max.</p>
<ul>
<li><p>RGB effects can have different hue, saturation, brightness (value), and the
effects can run at different speeds.<br />
It might make sense to provide the ability to increase/decrease these
through leader key sequences.</p></li>
<li><p>Tap Hold configuration supports <a href="https://docs.qmk.fm/tap_hold#dynamic-tapping-term">dynamic configuration of the tapping
term</a>.</p></li>
<li><p><a href="https://docs.qmk.fm/features/auto_shift">AutoShift</a> also has dynamic
configuration of its tapping term.</p></li>
</ul></li>
<li><p><a href="https://getreuer.info/posts/keyboards/macros3/index.html">“case modes”</a></p>
<ul>
<li><p>“caps word” is a neat feature, since it makes it easier to type out a single
word in all caps (e.g. variables with uppercase identifiers).</p></li>
<li><p>“case modes” generalises this feature, which would aim to make it easier to
write out <code>snake_case</code>, <code>kebab-case</code> or <code>./path/case</code> values.</p></li>
</ul></li>
<li><p><a href="https://docs.qmk.fm/features/dynamic_macros">Dynamic Macros</a></p>
<ul>
<li>Again, this is a neat feature, but I’m not quite sure where I’d position it
on a layer in a keymap.</li>
</ul></li>
<li><p>Send String and other shortcuts.</p>
<ul>
<li><p>From searching for “qmk leader sequence”, most uses of the leader key I
could find seem to be use of <code>SEND_STRING</code>, or as a convenient way to
access modifier-heavy keyboard shortcuts.</p>
<ul>
<li>Vaguely, the idea of using sequences of taps instead of simultaneous holds
of modifier keys resembles one shot mods, or <a href="https://github.com/qmk/qmk_firmware/blob/user-keymaps-still-present/users/callum/readme.md">callum-style
mods</a>,
which I’ve seen mentioned as a friendlier alternative to tap-hold home row
mods.</li>
</ul></li>
</ul></li>
</ul>
<h2 id="a-new-kind-of-modifier">“A New Kind of Modifier”</h2>
<p>The docs page for the QMK leader key has the subtitle “a new kind of modifier”.</p>
<p>Most keyboard shortcuts operate with modifier keys that you have to hold down.</p>
<ul>
<li><p>e.g. on a web browser, Ctrl+T opens a new tab, Ctrl+Shift+T re-opens a closed
tab.</p></li>
<li><p>e.g. in Emacs and macOS, shortcuts like Ctrl+a or Ctrl+e navigate in text.</p></li>
<li><p>on laptop keyboards, you hold down the Fn key to change the behaviour of some
other keys.</p>
<ul>
<li>or on small custom keyboards, you might access different keyboard layers by
holding down one or more Fn keys.</li>
</ul></li>
</ul>
<p>Modifier keys allow re-using the same set of physical keys for more actions.</p>
<p>Key sequences are another way of mapping functionality onto a set of keys.
(Although I’m not sure “modify key behaviour” is the best way to describe).</p>
<h2 id="implementation-notes-qmk-lead-timeout">Implementation Notes: QMK Lead Timeout</h2>
<p>I like defining <code>#define LEADER_NO_TIMEOUT</code> so that when inputting <code>LEAD r r</code>, I
don’t have to rush after invoking <code>LEAD</code>.</p>
<p>Setting <code>LEADER_PER_KEY_TIMING</code> also helps with long sequences. Maybe a
<code>LEADER_TIMEOUT</code> longer than the default 350ms might help for leader key
sequences same-finger bigrams.</p>
<p>https://docs.qmk.fm/features/leader_key#disabling-initial-timeout</p>
<h2 id="qmk-leader-key-sequence-idiosyncracies">QMK Leader Key Sequence Idiosyncracies</h2>
<p>The behaviour of key sequences I’m used to in Doom Emacs is that each sequence
must be unique and not the prefix of another sequence. (e.g. <code>spc f s</code> saves
file, but <code>spc f</code> does not map to a command).</p>
<p>QMK’s implementation is a bit more limited: the leader key sequence has a buffer
of up to 5 keycodes; and then once the leader key sequence has timed out, then
the <code>leader_end_user</code> can be used to check which leader key sequence was used.</p>
<p>An advantage here is this allows for “one sequence can be a prefix of another”.</p>
<p>The disadvantage is it imposes a delay after inputting the sequence. (Because
the leader key command behaviour is checked in the callback after the timeout,
there’s no way for the leader to end before the timeout).</p>
<p>I suspect an alternative implementation could overcome those limitations
(albeit, for different implementation costs).</p>
<h2 id="implementation-notes-qmk-combo">Implementation Notes: QMK Combo</h2>
<p>I have <code>LEAD</code> as a combo (chord) on my keymap.</p>
<p>In order to still use <code>LEAD</code> (and other combo keys) with different base layers
(e.g. qwerty instead of dvorak), I define:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define COMBO_ONLY_FROM_LAYER </span><span class="dv">0</span></span></code></pre></div>
<p>https://docs.qmk.fm/features/combo#layer-independent-combos</p>]]></summary>
</entry>
<entry>
    <title>Further Notes on Gym Going</title>
    <link href="http://www.rgoulter.com/blog//posts/2024-06-12-further-notes-on-gym-going.html" />
    <id>http://www.rgoulter.com/blog//posts/2024-06-12-further-notes-on-gym-going.html</id>
    <published>2024-06-12T00:00:00Z</published>
    <updated>2024-06-12T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I have continued going to the gym in the time <a href="2024-03-23-six-months-of-going-to-the-gym.html">since I wrote a blogpost with thoughts about going there for six months</a>.<br />
That post logged that I’d made good progress on fat loss goals, enjoyed going to the gym, thought some of the machines in the gym were neat.</p>
<p>Since then, I’ve paid more attention to resistance training.</p>
<p>Here are some scattered notes and links to things I’ve found interesting:</p>
<ul>
<li><p>I use ChatGPT less than I was using it before.</p>
<ul>
<li>I’ve since found resources which I find reputable.
Whereas, before, I’d at least found ChatGPT to be better than random blogspam.</li>
</ul></li>
<li><p>Great resource: <a href="https://exrx.net/" class="uri">https://exrx.net/</a></p>
<ul>
<li>This has many great pages on topics related to exercise.</li>
<li>I constantly refer to this website for its exercise library,
which lists exercises grouped by what muscle the exercise targets.
(e.g. if you want to know what exercises target the hamstrings, you can find a list there).</li>
<li>The exercises each have a video demonstrating how to perform the exercise,
as well as a description and comments.
<ul>
<li>You can often find similar exercises done with a barbell, dumbbells, cable machine, plate-loaded machine, selectorized.. or with a smith machine, or bodyweight. – Some exercises are locked behind a premium paywall, but <em>most</em> can be read for free.</li>
</ul></li>
</ul></li>
<li><p>Caveats about content creators:</p>
<ul>
<li>IMO: There are perverse incentives with YouTube channels and blogs:
<ul>
<li>There’s a conflict between “put out quality information” and “get discovered
by a recommendation algorithm”.
<ul>
<li>Recommendation algorithms tend to favour things that are fresh/new.</li>
<li>In health/fitness, it’s likely that good information is already well known
(by some people somewhere).</li>
</ul></li>
<li>I reckon that, especially for YouTube channels or blogs with high production value,
this leads to pushing out repeats of content, in order to stay ‘fresh’.</li>
</ul></li>
<li>Audience / context.
<ul>
<li>Beginners have a lot of room to grow/improve; for advanced practitioners, marginal increases can be expensive.
So, advice targeted at an intermediate or advanced level might not be necessary for a beginner level.
<ul>
<li>For beginners and for casual practitioners, it’s not necessarily worth pursuing 100% efficiency.</li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Great resources: Dr Mike Israetel’s <a href="https://www.youtube.com/@RenaissancePeriodization/videos">RenaissancePeriodization</a> (RP).</p>
<ul>
<li>Especially the channel’s <a href="https://www.youtube.com/@RenaissancePeriodization/playlists">playlists</a>, and its “made simple” series.</li>
<li>On the whole.. the channel’s content is geared towards intermediate and advanced lifters.</li>
</ul></li>
<li><p><a href="https://www.youtube.com/watch?v=dvYgXOFCeGM">Alexander Bromley’s video on exercise science</a> is an interesting “cold shower”.</p>
<ul>
<li>“Science” is catchy in video titles.
But the field Exercise Science as a field hasn’t made an impact on powerlifting or bodybuilding competitors.</li>
<li>Exercise Science suffers same factors as other soft sciences:
<ul>
<li>Issues with reproducibility (sometimes due to fraud).</li>
<li>Many variables to consider deal with, which makes it easy to confound results/understanding.</li>
</ul></li>
<li>Exercise science content often has to hedge with weasel words like “but if that works for you, it works for you”;
this undermines its prescriptive value.</li>
</ul></li>
<li><p>The LesMills BodyPump sessions that the gym holds have been an excellent way to build confidence with weights. It’s a good exercise.</p></li>
<li><p>Bioelectrical Impedance Analysis:</p>
<ul>
<li>The results I get from day to day vary. I like to think that by taking a frequent number of measurements,
(e.g. once for each session), overall the impact of the variation evens out.</li>
<li>e.g. <a href="https://www.youtube.com/watch?v=fQezbeaDXIc">Video from RP discussing ways to estimate Percentage Body Fat</a> discusses that using BIA is not as effective as that judging by weight &amp; strength performance. (e.g. “weight goes down &amp; strength stays same” would be positive; “weight up, strength down” would be negative).</li>
</ul></li>
<li><p><a href="https://www.youtube.com/watch?v=DupQfkoI-Sc">RP’s video on Rep Ranges</a></p>
<ul>
<li>This is basic/fundamental.</li>
<li>“Working set” is a set of repetitions (reps) that is challenging enough that you’re near the limit of what you can do.
<ul>
<li>e.g. ideally, you’re unable to do 15 reps with a weight which you plan to use for a set of 10. (If you could do 15 reps, the weight is too light).</li>
</ul></li>
<li>Lower reps = heavier weight = better for building strength. (Typically 3-6).</li>
<li>Higher reps = lighter weight = better for building muscle. (Anything up to 30 reps).</li>
<li>e.g. “Starting Strength” uses sets of 5 reps. (For beginners, 3 sets of 5 reps).</li>
</ul></li>
<li><p><a href="https://www.youtube.com/watch?v=UU2dpLFIOHU">Menno Henselman has a video discussing key ideas for strength/muscle development</a>.</p>
<ul>
<li>Doing more ‘volume’ of work (more sets, more reps) will result in more muscle.</li>
<li>For strength: short term, intensity is good. (Low reps).
<ul>
<li>However, since there’s a limit to how strong a muscle mass can get,
in the long term, more strength would require more muscle.</li>
<li>Menno describes the relationship between strength/muscle size using an analogy of a race car: a race car might go faster by the driver improving his skills, or by improving the car’s engine.</li>
</ul></li>
</ul></li>
<li><p>I liked RP’s “made simple” series, particularly its playlists about <a href="https://www.youtube.com/playlist?list=PLyqKj7LwU2RulAjHczohbx5OyJQ8TaFM0">fat loss</a> and <a href="https://www.youtube.com/playlist?list=PLyqKj7LwU2RvZhQ739Mg9v8cLotbX_qE3">cardio</a>:</p>
<ul>
<li>Fat loss:
<ul>
<li>The key factor is “calorie deficit” (calories in &lt; calories out).
<ul>
<li>Diet (in the sense of “what food you eat”) plays a much more significant role than exercise.
<ul>
<li>There’s a limit to the amount of energy you can expend in a day.
<ul>
<li>If you perform too much exercise, your body will conserve energy for the remaining part of the day.
(e.g. you’ll not get up &amp; do things).</li>
</ul></li>
<li>Exercise also accumulates fatigue and risk of injury, so can’t be done to excess.</li>
<li>To an extent: reaching (or increasing) calorie deficit involves doing what’s least awful of reducing what you eat or exercising more.</li>
</ul></li>
<li>An often touted goal of keto diet (low carb) is to burn fat for energy by;
but, this doesn’t supersede “calories in, calories out”.
<ul>
<li>Excess calories will still get stored as fat;
calorie deficit will still burn fat.</li>
<li>However, high-carb food is often not satiating;
(e.g. chips; you’d have to eat many potato chips to feel full).
So, avoiding high-carb food is a good idea.</li>
</ul></li>
</ul></li>
</ul></li>
<li>Cardio:
<ul>
<li>“Stimulus to Fatigue” needs to be considered.
<ul>
<li>e.g. Sprinting burns many calories per second, but is too fatiguing to sustain for some time.</li>
<li>Dr Mike rates elliptical machine highly.</li>
<li>Dr Mike rates using step-counter and aiming to reach 8k/10k/12k steps per day highly.
<ul>
<li>Good energy expenditure; very low disruption to day’s activities.</li>
<li>Very low fatigue / risk of injury.</li>
<li>Not ‘fun’, but walking around is an ubiquitous part of the day.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><p>Nutrition:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=oCDqqVwYMa4">Discussion of Diet Soda and Aspartame</a>.
<ul>
<li>Although “Diet soda cancer” makes headlines,
it’d be foolishly inaccurate to think “diet soda unhealthy; regular soda is healthier”.</li>
</ul></li>
<li>A few key ideas Dr Mike repeats in various places:
So long as you’re getting a certain minimum of macronutrients/micronutrients,
the overall composition of where calories come from is not important.
<ul>
<li>c.f. <a href="https://edition.cnn.com/2010/HEALTH/11/08/twinkie.diet.professor/index.html">Mark Haub’s Twinkie study</a>,
where he was able to reduce fat from a caloric deficit, while two thirds of the calories he ate came from twinkies</li>
</ul></li>
</ul></li>
<li><p>Machines vs free weights:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=iIcWxvplE6Y">Menno Henselman</a> cites papers which compared training with free weights against training with machines.
<ul>
<li>Supposed thoughts: Since machines are stable, should be able to get more strength out of them; machines worse for joints and muscle growth.</li>
<li>The studies show:
<ul>
<li>Due to specificity: you’ll do slightly better on the one you train with.</li>
<li>But for health benefits: do whatever you prefer.</li>
<li>For machines: it’s slightly better to use plate-loaded machines with a free range of motion, than lever selectorized machines with a fixed range of motion.</li>
</ul></li>
</ul></li>
<li>e.g. I recall seeing that Nassim didn’t like weight machines and thought they’re stupid.</li>
<li><a href="https://www.youtube.com/watch?v=qIFYgb7Mvu0">RP discusses that “gotta use barbells!” overstates it</a>.
<ul>
<li>Barbell lifts (especially heavy compound exercises) are great; but, it would be wrong to assert they’re the best for all cases.</li>
</ul></li>
</ul></li>
<li><p>Doing cardio and resistance training in the same session:</p>
<ul>
<li>I’ve seen that doing cardio after doing resistance leads to an “interference effect” where the muscle won’t gain as much since the body’s recovering from cardio.</li>
<li>This seems plausible to me. But, “no interference effect” also seems plausible.</li>
<li>At least, it does seem “trade Peter for Paul”: time spent on cardio is time spent not doing resistance training, and vice versa. It’s easier to perform well when starting fresh.</li>
<li>As such, I do split up my gym sessions between “focus on cardio” and “focus on resistance training”.</li>
</ul></li>
<li><p>RP’s <a href="https://www.youtube.com/watch?v=a5Yzg5K5EPE">Definition of Beginner (from the Hypertrophy Made Simple series): “when improvement is automatic”</a>.</p>
<ul>
<li>I reckon this is a reasonable and interesting use of the word “beginner”.
For beginners, improvement is easy.
<ul>
<li>As opposed to “beginner is someone who has been lifting for up to 6 months” or whatever.</li>
</ul></li>
<li>The <a href="https://www.youtube.com/watch?v=-8Sgczn4VsM">Strength Made Simple series’ equivalent video concurs</a>:
it defines beginner as “sees improvement from adhering to basics”.</li>
</ul></li>
<li><p>ExRx’s <a href="https://exrx.net/ExInfo/Etiquette">page about Gym Etiquette</a>.</p>
<ul>
<li>This is all mostly obvious. Don’t make things unpleasant for others.</li>
<li>I’ve noticed that in practice, “unrack weights from the machine you’re using” isn’t intuitive.</li>
</ul></li>
<li><p>ExRx discussing <a href="https://exrx.net/Questions/LegPressLockOut">Locking out on leg press machine</a>.</p>
<ul>
<li>There are some nasty “gym fails” videos which feature injuries on leg press machines.</li>
<li>ExRx discusses that the problem is putting the knee under stress it’s not adapted to.</li>
<li>This risk of injury can be prevented by always controlling the weight of the leg press.
(e.g. don’t lock out in an uncontrolled manner), and don’t use more weight than your legs can handle.</li>
</ul></li>
<li><p><a href="https://www.youtube.com/watch?v=kW8KP-rlKTk">Alexander Bromley’s Bench Press (“for no gains” series)</a>.</p>
<ul>
<li>An interesting point: the two most popular YouTube videos about bench pressing
recommend different techniques: Bromley explains that one technique is optimal for powerlifting (where the focus is strength),
the other is optimal for hypertrophy (building muscle).</li>
</ul></li>
<li><p>Fatigue &amp; Recovery:</p>
<ul>
<li>Obvious constraints to exercise are “time available” and “effort you’re willing to put in”.</li>
<li>Less obvious to me was that fatigue is an important constraint.
<ul>
<li>Working beyond what the body can recover from risks injury.</li>
<li>This also indicates: rest and <em>sleep</em> are important for improvement.</li>
</ul></li>
</ul></li>
<li><p>Number of sets:</p>
<ul>
<li>RP’s discussions
<ul>
<li><a href="https://www.youtube.com/watch?v=Nh4qa-Y1CIo">for hypertrophy</a>,
<ul>
<li>Per muscle:
<ul>
<li>Aim for muscle to be pumped, and muscle disrupted. (&amp; should feel burn, if using a low enough weight).</li>
<li>For beginners, 1-5 sets targetting the muscle can be enough.</li>
<li>If can’t recover for the next session, you’re doing too much.</li>
</ul></li>
<li>Per session:
<ul>
<li>If too fatigued, it’s difficult to push target muscle to failure.</li>
<li>15-25 sets per session.</li>
</ul></li>
</ul></li>
<li><a href="https://www.youtube.com/watch?v=b9RcebQyG0A&amp;t=147s">for strength</a>
<ul>
<li>Per movement:
<ul>
<li>At least 1 heavy working set. Higher intensity is better.</li>
<li>If you can’t recover for next session, you’re doing too much.</li>
</ul></li>
<li>Per session:
<ul>
<li>Probably not worth the effort if can’t lift sufficiently heavy weight.</li>
<li>If you’re tired, anything will ‘feel’ heavy/difficult.
<ul>
<li>IMO: Seems unlikely that “get tired, then lift light weights” would lead to strength gains.</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
<li><p>RP on <a href="https://www.youtube.com/watch?v=eadyCiB0G3A">rounding the back during exercises</a>:</p>
<ul>
<li>Rounding the back risks injury. Lifting should be done with a neutral back.</li>
<li>On the other hand, rounding the back builds resiliency.</li>
<li>Synthesising these: keep the back neutral for heavy lifts; train the lower back with suitable exercises (&amp; light enough weight).</li>
</ul></li>
<li><p><a href="https://exrx.net/Lists/WorkoutMenu">ExRx Workout Templates</a>.</p>
<ul>
<li>These are great.
<ul>
<li>Provides a guide on what kinds of exercises are useful to aim for at the gym.
<ul>
<li>This is useful for more direction than just “uh, I’ll use whatever machines are available”.</li>
</ul></li>
</ul></li>
<li>The pages mention useful qualifiers like “don’t do these kinds of exercises on the same day”.</li>
</ul></li>
</ul>]]></summary>
</entry>
<entry>
    <title>Bridgerton Season 3</title>
    <link href="http://www.rgoulter.com/blog//posts/romance/2024-05-27-bridgerton-season-3.html" />
    <id>http://www.rgoulter.com/blog//posts/romance/2024-05-27-bridgerton-season-3.html</id>
    <published>2024-05-27T00:00:00Z</published>
    <updated>2024-05-27T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>Finished watching Bridgerton Season 3.</p>
<p>I don’t know why it’s 4 episodes. Season 1 and 2 had 8 each.<br />
I guess they’re moving away from 1 season = 1 book.</p>
<p>This time, we see the romance primarily between Colin Bridgerton and Penelope.<br />
It also features, to a lesser degree, romance between Francesca Bridgerton &amp;
Lord Kilmartin.</p>
<h2 id="what-it-did-well">What It Did Well</h2>
<p>The sweet parts are <em>so</em> sweet!</p>
<p>I think the romantic plot between Francesca and Kilmartin is very well done.<br />
It’s cheesey.<br />
It’s very adorable.<br />
I think it’s a very ideal depiction of two utter nerds flirting. Most of the
time nerds in media are depicted as just spewing a bunch of technical jargon..
but with Francesca &amp; Kilmartin, we get people who are just somewhat socially
awkward.</p>
<p>My favourite part of this season, Francesca sees Kilmartin walking through the
streets and excitedly goes up to greet him; when she flirts with him, he
responds obtusely with an overly literal response, and the air deflates. It’s
awkward; there’s tension; and both of them are thinking “did I do something
wrong?”. Or, rather, this part is so good because later, Kilmartin redeems the
awkwardness by giving a very geeky gift; and it’s such a sweet resolution to the
tension that was built up.</p>
<p>The romance between Colin and Penelope is solid.<br />
I think it’d be enough to carry the season on its own.<br />
I’m a simple man with simple tastes. I like a sweet story, well executed.</p>
<p>I don’t recall if it was done the same in S1 or S2, but in this one at least, Lady Bridgerton got to fulfil that Dumbledore-eque “knows things, nudges in the right direction” kind of role.<br />
It’s a good archetype, and cliches are cliche for a reason.</p>
<p>I was pleasantly surprised by the friendship between Eloise and Cressida.<br />
Cressida’s character always seemed like a shallow bitch rival.<br />
In this season, she’s portrayed with more sympathy. She’s lonely as a
consequence of her cruel actions.<br />
Eloise’s character is more rounded and balanced than it was in earlier seasons:
here, she mostly retains the character of “eww, I’m not interested in feminine
things like sewing”. (Which is nice; means you’re avoiding every female
character being the same character).</p>
<p>It was also good to see that the suitor Penelope was chasing was a fairly charming and pleasant man.</p>
<h2 id="what-it-did-poorly">What It Did Poorly</h2>
<p>The show’s already made its bed, I guess, but the sex scenes are superfluous and
don’t really add much to the show. Worse, it makes it a “don’t want to watch
this with my family”.<br />
I get that the sex scenes are important in the novels, in defiance of
prudishness, and in favour of female sexual empowerment, or as a tangible plot
point demonstrating the intensity of the love interest. But as depicted in the
Bridgerton S3, it comes closer to “our show has sex scenes, just like other cool
shows have sex scenes”.<br />
At the, uh, climax of the season, we have a classical arrangement of some pop
song triumphantly blasting as Colin pleasures Penelope.. it felt more “amusing”
than “hot”.<br />
– Instead: I think it’d be better to just skip the sex scenes altogether.</p>
<p>Generally, though.. I think the show suffers in the same way that I reckon
Columbo does:<br />
In Columbo, every episode I want to see Columbo annoy the villain, ask innocuous
questions, and ask “just one more thing”, before eventually catching the villain
in the villain’s web of lies. I reckon the problem was, they never quite landed
on what to do with the <em>rest</em> of the runtime, so you’d get weird gimmicky
plotlines that fell flat more than they landed. – The core, good part of what
people like about the show needs padding to support it, otherwise it’d just be
15 minutes long.<br />
Here, the sweet romance stuff is great. I wanna see the hero &amp; heroine flirt,
bicker, dance, and get together. But what to do with the rest of the runtime?</p>
<p>There’s the old adage “both original and good; but the good parts aren’t
original, and the original parts aren’t good”.<br />
I don’t think an adaptation needs to be all that original; especially not for
the first time it’s being adapted.</p>
<p>And a lot of the original stuff in Netflix’s Bridgerton is just … not good.</p>
<p>A major subplot throughout the whole season is that Penelope’s newlywed sisters
need to get pregnant.<br />
And the sisters are naive about how to make babies; and their husbands are
terrible lovers.<br />
The whole thing is an awkward joke, but it’s not particularly funny.<br />
(It’s easy to see Penelope’s sisters as the butt of a joke in a laughing-at-them
kind of way. I think it detracts more than it adds).</p>
<p>I think it’s no different than other seasons, but I recall really enjoying Lady
Danbury’s character in the books as a fierce character with almost
fourth-wall-breaking frankness. And in this show, she’s a silly gossip who’s a
lacky to the Queen character. Zzzz.</p>
<p>Though, speaking of fourth-wall-breaking frankness: the boxer/club owner
Mondrich and his wife continue to feature in this season. I recall in S1,
Mondrich’s wife came across as talking like someone with a smartphone in her
pocket. (Bridgerton (books or otherwise) strives for fun over historical
fidelity; but, at some point, why not just have a story set in the present?).<br />
I think the show was not really short of strong-independent-female characters.
But in this season, Mondrich’s wife is written differently, and shows a vanity
by way of concern for what others in society will think of her if she doesn’t
appear as her social class expects her to. I reckon the change was jarring.</p>
<p>And while it’s more a problem with the genre than the show itself.. but I still
don’t like seeing “the hero is cool, the other men are losers” nor “the heroine
is cool, the other women are losers”.<br />
In Bridgerton S3, we see that a marquess tries to court Francesca; but, he’s
shown to be crass or otherwise undesirable. Ehhh. I don’t think the story
benefits from this.<br />
Penelope’s story is nicer, and more romantic: her primary concern being the
security that’d come from a marriage, and she manages to catch the interests of
a smart and friendly vegetarian. He’s not a loser, she could live happily with
him. (On the other hand, Colin is shown frequenting a brothel several times. It
doesn’t endear him to me. I think I’d prefer the trope where he otherwise chases
after some girl, without realising his feelings are truly for Penelope).</p>
<p>The show still also suffers from light (or otherwise) touches of progressivism.<br />
There’s a joke in The Simpsons where Lisa Simpson boldly walks up to the
football team and bravely says “I want to join! That’s right, a girl!”. (Lisa is
then deflated to find that the team already has girls).<br />
I was reminded of that by one part in Bridgerton S3, when a group of men are
laughing/mocking an inventor for his hot air balloon, and a woman interrupts
saying “I came hear to learn things”; Benedict Bridgerton thanks her, then
remarks “oh, you’re a woman”, and she gives the same kind of “that’s right, I’m
a woman who can read” kind of reply.<br />
Do people enjoy story beats like that? I enjoy the geeky characters being well
written. Maybe someone enjoys these “I was brave! and everybody clapped” type
stuff.<br />
– It’s kindof bizarre that someone would want to have fun by proselytizing
progressivism, but also set a story in a setting wherein “woman needs to get
married to secure her future” is a key driver of plots in the story.</p>]]></summary>
</entry>
<entry>
    <title>Getting MounRiver Studio to Run on NixOS</title>
    <link href="http://www.rgoulter.com/blog//posts/programming/2024-05-23-getting-mounriver-studio-to-run-on-nixos.html" />
    <id>http://www.rgoulter.com/blog//posts/programming/2024-05-23-getting-mounriver-studio-to-run-on-nixos.html</id>
    <published>2024-05-23T00:00:00Z</published>
    <updated>2024-05-23T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>In <a href="../programming/2024-05-22-example-of-cannot-execute-required-file-not-found-on-nixos.html">the previous post</a>,
I walked through a few different ways of how to get a pre-compiled binary running on NixOS.</p>
<p>In this post, I’ll share some notes on what it took to get <a href="http://www.mounriver.com/download">MounRiver</a> running on NixOS.
The basic idea is the same, but in practice it felt much more difficult.
(MounRiver Studio is an IDE used for WCH MCUs. <a href="../programming/2023-12-21-notes-on-building-wch-ble-ch592-evt-exam-with-bare-makefile.html">I’ve discussed developing the EVT examples in a previous blogpost</a>).</p>
<p>If the previous post was “draw a circle”, this post is “<a href="https://knowyourmeme.com/memes/how-to-draw-an-owl">draw the rest of the owl</a>”.</p>
<p>These notes are mostly “here are the commands I ran, here was the output”:</p>
<p>The Community RISC-V IDE can be downloaded from the MounRiver website. It’s a tarball with a <code>beforeinstall</code> (with some <code>.so</code> shared libraries to be copied into <code>/usr/lib</code>), and an <code>MRS_Community</code> directory which is a distribution of the <a href="https://eclipseide.org/">Eclipse IDE</a>.</p>
<p>First thing to try: just running the executable directly:</p>
<pre><code>$ ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver\ Studio_Community
exec: Failed to execute process &#39;./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver Studio_Community&#39;: The file exists and is executable. Check the interpreter or linker?</code></pre>
<p>or with bash:</p>
<pre><code>bash: ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver Studio_Community: cannot execute: required file not found</code></pre>
<p>This “required file not found” should be familiar, having read the previous blogpost.</p>
<p>So, checking what <code>ldd</code> says:</p>
<pre><code>$ ldd ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver\ Studio_Community
        linux-vdso.so.1 (0x00007ffd249d4000)
        libpthread.so.0 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libpthread.so.0 (0x00007fc32c3d8000)
        libdl.so.2 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libdl.so.2 (0x00007fc32c3d3000)
        libc.so.6 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libc.so.6 (0x00007fc32c1ea000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib64/ld-linux-x86-64.so.2 (0x00007fc32c3df000)</code></pre>
<p>Indeed, the dynamic linker is <code>/lib64/ld-linux-x86-64.so.2</code>. (So far, this is the same as the hello world example from the previous post).</p>
<h2 id="approach-1-using-nix-alien">Approach 1: Using Nix Alien</h2>
<p>In the previous post, we saw <a href="https://github.com/thiagokokada/nix-alien">nix-alien</a> could automatically work around some problems. Trying that:</p>
<pre><code>$ nix-alien ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver\ Studio_Community
/home/rgoulter/playground/nix-mounriver-studio/MounRiver_Studio_Community_Linux_x64_V160/MRS_Community//plugins/org.eclipse.justj.openjdk.hotspot.jre.full.linux.x86_64_14.0.2.v20200815-0932/jre/bin/java: error while loading shared libraries: libz.so.1: cannot open shared object file: No such file or directory
MounRiver Studio_Community:
JVM terminated. Exit code=127
/home/rgoulter/playground/nix-mounriver-studio/MounRiver_Studio_Community_Linux_x64_V160/MRS_Community//plugins/org.eclipse.justj.openjdk.hotspot.jre.full.linux.x86_64_14.0.2.v20200815-0932/jre/bin/java
-Dosgi.requiredJavaVersion=11
-Dosgi.instance.area.default=@user.home/mrs_community-workspace
....</code></pre>
<p>The key detail of this output being <code>... libz.so.1: cannot open ...</code>:</p>
<pre><code>plugins/org.eclipse.justj.openjdk.hotspot.jre.full.linux.x86_64_14.0.2.v20200815-0932/jre/bin/java: error while loading shared libraries: libz.so.1: cannot open shared object file: No such file or directory</code></pre>
<p>Checking <code>ldd</code> on this <code>java</code> binary:</p>
<pre><code>$ ldd ..../jre/bin/java
        linux-vdso.so.1 (0x00007ffe3abb5000)
        libz.so.1 =&gt; not found
        libjli.so =&gt; /home/rgoulter/playground/nix-mounriver-studio/MounRiver_Studio_Community_Linux_x64_V160/MRS_Community//plugins/org.eclipse.justj.openjdk.hotspot.jre.full.linux.x86_64_14.0.2.v20200815-0932/jre/bin/../lib/libjli.so (0x00007ff14489c000)
        libpthread.so.0 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libpthread.so.0 (0x00007ff144897000)
        libdl.so.2 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libdl.so.2 (0x00007ff144892000)
        libc.so.6 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libc.so.6 (0x00007ff1446a7000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib64/ld-linux-x86-64.so.2 (0x00007ff1448b3000)
        libz.so.1 =&gt; not found</code></pre>
<p>Indeed, <code>libz.so.1 =&gt; not found</code>.</p>
<p>We can add <code>--additional-libs=libz.so.1</code>
to the <code>nix-alien</code> call, which helpfully lets us pick the package <code>libz</code>. (We could instead use <code>--additional-packages=libz</code> if we already know <code>libz</code> is the name of the nix package with <code>libz.so.1</code>). Re-running <code>nix-alien</code> with this still runs into problems:</p>
<pre><code>$ nix-alien --recreate --additional-libs=libz.so.1 ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver\ Studio_Community
MounRiver Studio_Community:
An error has occurred. See the log file
/home/rgoulter/playground/nix-mounriver-studio/MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/configuration/1716348838071.log.</code></pre>
<p>Checking the contents of that log file:</p>
<pre><code>!SESSION 2024-05-22 03:33:57.978 -----------------------------------------------
eclipse.buildId=4.17.0.I20200902-1800
java.version=14.0.2
java.vendor=Oracle Corporation
BootLoader constants: OS=linux, ARCH=x86_64, WS=gtk, NL=en_US
Framework arguments:  -product org.eclipse.epp.package.embedcdt.product
Command-line arguments:  -os linux -ws gtk -arch x86_64 -product org.eclipse.epp.package.embedcdt.product

!ENTRY org.eclipse.osgi 4 0 2024-05-22 03:33:59.069
!MESSAGE Application error
!STACK 1
java.lang.UnsatisfiedLinkError: Could not load SWT library. Reasons:
        no swt-pi4-gtk-4936r26 in java.library.path: [/run/opengl-driver/lib, /run/opengl-driver-32/lib, /usr/java/packages/lib, /usr/lib64, /lib64, /lib, /usr/lib]
        no swt-pi4-gtk in java.library.path: [/run/opengl-driver/lib, /run/opengl-driver-32/lib, /usr/java/packages/lib, /usr/lib64, /lib64, /lib, /usr/lib]
        Can&#39;t load library: /home/rgoulter/.swt/lib/linux/x86_64/libswt-pi4-gtk-4936r26.so
        Can&#39;t load library: /home/rgoulter/.swt/lib/linux/x86_64/libswt-pi4-gtk.so
....</code></pre>
<p><code>~/.swt/lib/linux/x86_64/</code> doesn’t have the <code>pi4</code> lib, but it does have a <code>pi3</code> one:</p>
<pre><code>$ ls /home/rgoulter/.swt/lib/linux/x86_64/
libswt-pi3-gtk-4936r26.so*

$ ldd /home/rgoulter/.swt/lib/linux/x86_64/libswt-pi3-gtk-4936r26.so

        linux-vdso.so.1 (0x00007fffa2b60000)
        libgtk-3.so.0 =&gt; not found
        libgdk-3.so.0 =&gt; not found
        libcairo.so.2 =&gt; not found
        libgthread-2.0.so.0 =&gt; not found
        libc.so.6 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libc.so.6 (0x00007fc0c9a17000)
        /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib64/ld-linux-x86-64.so.2 (0x00007fc0ca004000)</code></pre>
<p>Here, the <code>libswt</code> shared library can’t load, because shared libraries it links against aren’t there.</p>
<p>With that, let’s add packages <code>cairo</code>, <code>glib</code>, <code>gtk3</code> to the <code>nix-alien</code> invocation.</p>
<pre><code>$ nix-alien --recreate --additional-packages=libz -p cairo -p gtk3 -p glib ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver\ Studio_Community</code></pre>
<p>And it runs!</p>
<p>Further invocations of <code>nix-alien</code> can just run the binary directly:</p>
<pre><code>$ nix-alien ./MounRiver_Studio_Community_Linux_x64_V160/MRS_Community/MounRiver\ Studio_Community</code></pre>
<h2 id="approach-2-using-patchelf-on-the-binaries-directly">Approach 2: Using patchelf on the Binaries Directly</h2>
<p>Although using <code>nix-alien</code> works, I was curious to see what it would take to beat the thing into shape using <code>patchelf</code> directly. (This is obviously a more tedious way of approaching the problem).</p>
<p>It’s possible to run <code>patchelf</code> against everything that looks like it could be an executable binary, and let <code>patchelf</code> sort out whether the interpreter needs to be set or not:</p>
<pre><code>interpreter=/nix/store/....-glibc-2.39-5/lib64/ld-linux-x86-64.so.2

find ./MounRiver_Studio_Community_Linux_x64_V160 -type f -executable -exec file {} \; \
  | grep ELF \
  | cut -d: -f1 \
  | xargs -i sh -c &quot;patchelf --set-interpreter $interpreter \&quot;{}\&quot; || true&quot;</code></pre>
<p>(Find files which are executable, and run <code>file</code> on them; filter the output to ELF files (binaries and libraries), take the output up till the first <code>:</code>, and run this against <code>patchelf</code>).</p>
<p>This will take care of the interpreter being set to <code>/lib64/ld-linux-x86-64.so.2</code> in the binaries for running on this machine. (I’m not suggesting this is a clean approach to the problem).</p>
<p>I had also tried running <code>patchelf --set-interpreter</code> against each each executable as it caused a problem. This lead to iteratively running the program, seeing what didn’t work, and then patching whatever binary couldn’t be executed due to its interpreter not being found.<br />
This was a bit tedious, since it involved the eclipse binary, the JRE it uses, and the toolchains in the same distribution (<code>make</code>, and then the GCC components).</p>
<p>I found the link between Eclipse and the toolchains in its distributions:<br />
In the project settings, under Project -&gt; C/C++ Build -&gt; Settings -&gt; Toolchains tab, the toolchains are set to the binaries in this MounRiver distribution.</p>
<p>I think plaintext files are simpler to understand than configuration via a UI. Eclipse seems to be oriented around configuration through the UI.</p>
<p>As with the <code>nix-alien</code> solution above, of course the program also ran into problems with missing shared libraries when loading SWT.</p>
<p>I opted to set <code>LD_LIBRARY_PATH</code> in a <code>shell.nix</code>, and so would open MounRiver wtih this <code>shell.nix</code> loaded:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">libs</span> <span class="op">=</span> <span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">[</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    libz</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    cairo</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    glib</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    gtk3</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>pkgs.mkShell <span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">LD_LIBRARY_PATH</span> <span class="op">=</span> pkgs.lib.makeLibraryPath libs<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="using-the-mounriver-ide-for-wct-evt-examples">Using the MounRiver IDE for WCT EVT Examples</h2>
<p>While trying the MounRiver IDE to build the CH592 EVT examples, I ran into a problem where it couldn’t find the <code>CH59xBLE</code> lib.</p>
<pre><code>$ ls /home/rgoulter/github/ch592/EVT_V1.0/EXAM/BLE/LIB

.... LIBCH59xBLE.a ....</code></pre>
<p>This should be renamed to <code>libCH59xBLE.a</code> in order for the linker to find it.</p>
<p>Presumably the developers distributing the EVT are using a case-insensitive filesystem.</p>
<p>Issues like that, and the distributed Eclipse containing whitespace in the executable/toolchain paths, smell sloppy to me.</p>
<h2 id="attempting-to-package-this-in-nix">Attempting to Package this in Nix</h2>
<p>I expect using the <code>buildFHSEnv</code> would likely result in a package which works. (Albeit, for distributing as a package, care would need to be taken for unpacking the binary).</p>
<p>However, it’s cleaner to write a Nix package using <code>stdenv.mkDerivation</code>.<br />
And by writing a package, it’s going to be easier for others to use, or for me to re-use without having to make assumptions about where I put different files.</p>
<p>For the first attempt, we copy the approach as with the <code>autoPatchelfHook</code> example in the previous blogpost, e.g. <code>mounriver.nix</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">stdenv</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">autoPatchelfHook</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libz</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">cairo</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">glib</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">gtk3</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">pname</span> <span class="op">=</span> <span class="st">&quot;mounriver studio community&quot;</span><span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;V160&quot;</span><span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> <span class="ss">./MounRiver_Studio_Community_Linux_x64_V160.tar.xz</span><span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    autoPatchelfHook</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    libz</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    cairo</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    glib</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    gtk3</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    libXtst</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    libsecret</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    alsa-lib</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># breaks on whitespace</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="va">dontUpdateAutotoolsGnuConfigScripts</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="va">doBuild</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="va">installPhase</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="st">    mkdir -p $out</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="st">    cp -r ./MRS_Community/* $out</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span><span class="op">;</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>and a <code>default.nix</code> with:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>pkgs.callPackage <span class="ss">./mounriver.nix</span> <span class="op">{}</span></span></code></pre></div>
<p>that we build with <code>nix-build</code>.</p>
<p>This results in some errors:</p>
<pre><code>error: auto-patchelf could not satisfy dependency libXtst.so.6 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/plugins/org.eclipse.justj.openjdk.hotspot.jre.full.linux.x86_64_14.0.2.v20200815-0932/jre/lib/libawt_xawt.so
error: auto-patchelf could not satisfy dependency libasound.so.2 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/plugins/org.eclipse.justj.openjdk.hotspot.jre.full.linux.x86_64_14.0.2.v20200815-0932/jre/lib/libjsound.so
error: auto-patchelf could not satisfy dependency libsecret-1.so.0 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/plugins/org.eclipse.equinox.security.linux.x86_64_1.1.300.v20190830-1238/libkeystorelinuxnative.so
error: auto-patchelf could not satisfy dependency libusb-1.0.so.0 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/OpenOCD/bin/openocd
error: auto-patchelf could not satisfy dependency libhidapi-hidraw.so.0 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/OpenOCD/bin/openocd
error: auto-patchelf could not satisfy dependency libjaylink.so.0 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/OpenOCD/bin/openocd
error: auto-patchelf could not satisfy dependency libncurses.so.5 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/arm-none-eabi-gcc/bin/arm-none-eabi-gdb
error: auto-patchelf could not satisfy dependency libtinfo.so.5 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/arm-none-eabi-gcc/bin/arm-none-eabi-gdb
error: auto-patchelf could not satisfy dependency libncurses.so.5 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/arm-none-eabi-gcc/bin/arm-none-eabi-gdb-py
error: auto-patchelf could not satisfy dependency libtinfo.so.5 wanted by /nix/store/vhjxnm2ris1rnnc3zgwbi55z5f3ah9ak-mounriver-studio-community-V160/toolchain/arm-none-eabi-gcc/bin/arm-none-eabi-gdb-py</code></pre>
<p>The <code>libusb-1.0.so.0</code>, <code>libhidapi</code>, <code>libjaylink</code>, etc. helps explain why these shared libraries were included in the <code>beforeinstall</code> directory. (They’re used by openocd and gdb).</p>
<p>Anyway, adding the libraries for these to the <code>buildInputs</code></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">stdenv</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">autoPatchelfHook</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libz</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">cairo</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">glib</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">gtk3</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">hidapi</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libjaylink</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libusb1</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">ncurses5</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libXtst</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">alsa-lib</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libsecret</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>:</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">pname</span> <span class="op">=</span> <span class="st">&quot;mounriver studio community&quot;</span><span class="op">;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;V160&quot;</span><span class="op">;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> <span class="ss">./MounRiver_Studio_Community_Linux_x64_V160.tar.xz</span><span class="op">;</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    autoPatchelfHook</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    libz</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    cairo</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    glib</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    gtk3</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    hidapi</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    libjaylink</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    libusb1</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    ncurses5</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    libXtst</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    libsecret</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    alsa-lib</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># breaks on whitespace</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  <span class="va">dontUpdateAutotoolsGnuConfigScripts</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  <span class="va">doBuild</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  <span class="va">installPhase</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="st">    mkdir -p $out</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="st">    cp -r ./MRS_Community/* $out</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span><span class="op">;</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This package recipe is able to <em>build</em>, but the resulting Eclipse doesn’t successfully <em>run</em>.</p>
<p>Unsurprisingly, it can’t load the shared libraries for the SWT library.<br />
<code>nix-alien</code> solved this by adding <code>cairo glib gtk3</code> to its FHS env.<br />
Replacing the interpreter fixed this by adjusting <code>LD_LIBRARY_PATH</code>.<br />
Here, we can use <code>wrapProgram</code> to adjust the <code>LD_LIBRARY_PATH</code> with <code>lib.makeLibraryPath [ cairo glib gtk3 ]</code>. This ensures <code>LD_LIBRARY_PATH</code> runs with a value we want when we run the program.</p>
<p>Hence:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">lib</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">stdenv</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">autoPatchelfHook</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">makeWrapper</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libz</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">cairo</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">glib</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">gtk3</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">hidapi</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libjaylink</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libusb1</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">ncurses5</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libXtst</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">alsa-lib</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">libsecret</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>:</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>  <span class="va">pname</span> <span class="op">=</span> <span class="st">&quot;mounriver studio community&quot;</span><span class="op">;</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;V160&quot;</span><span class="op">;</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> <span class="ss">./MounRiver_Studio_Community_Linux_x64_V160.tar.xz</span><span class="op">;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    autoPatchelfHook</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    makeWrapper</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    libz</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    cairo</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    glib</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    gtk3</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    hidapi</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    libjaylink</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    libusb1</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    ncurses5</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    libXtst</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    libsecret</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    alsa-lib</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># breaks on whitespace</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>  <span class="va">dontUpdateAutotoolsGnuConfigScripts</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  <span class="va">doBuild</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  <span class="va">installPhase</span> <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="st">    mkdir -p $out</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="st">    cp -r ./MRS_Community/* $out</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="st">    wrapProgram &quot;$out/MounRiver Studio_Community&quot; --prefix LD_LIBRARY_PATH : </span><span class="sc">${</span>lib.makeLibraryPath <span class="op">[</span> cairo glib gtk3 <span class="op">]</span><span class="sc">}</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span><span class="op">;</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This runs, but compared to the MounRiver run by <code>nix-alien</code>, the toolchains in the project settings are empty, and so the IDE doesn’t “just work” for building the WCH EVT examples.</p>
<p>In the MounRiver which did build the WCT EVT examples, the toolchain paths were set to values like <code>${eclipse_home}toolchain/make-3.8/usr/local/bin</code> or <code>${eclipse_home}/toolchain/RISC-V Embedded GCC/bin</code>.</p>
<p>Searching for these strings, in the <code>MRS_Community</code> folder:</p>
<pre><code>$ rg --hidden --fixed-strings &#39;${eclipse_home}toolchain&#39;
configuration/.settings/ilg.gnumcueclipse.managedbuild.cross.prefs</code></pre>
<p>It’s not clear to me <em>why</em> the Eclipse running from this <code>mounriver.nix</code> Nix package doesn’t pick these settings up.<br />
My guess is something to do with the <code>configuration/.settings</code> being read-only in the <code>/nix/store</code>.<br />
I noticed that copying the <code>configuration</code> from the <code>/nix/store</code> (or just the extracted <code>MRS_Community</code> directory) to the directory in <code>~/.eclipse</code> did set the global toolchain paths; but I’m not sure where/how that directory in <code>~/.eclipse</code> comes into things, either. (Whereas, say, the <code>.ini</code> file in <code>MRS_Community</code> does define <code>osgi.instance.area.default=@user.home/mrs_community-workspace</code>).</p>
<p>At this point, it’s worth looking at code in nixpkgs.
<a href="https://search.nixos.org/packages?channel=23.11&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=eclipse">Searching for packages named “eclipse”</a>, and then opening up <a href="https://github.com/NixOS/nixpkgs/blob/nixos-23.11/pkgs/applications/editors/eclipse/build-eclipse.nix">the source code</a>.<br />
The build inputs &amp; wrapping with <code>LD_LIBRARY_PATH</code> looks familiar. This nixpkgs code has code to deal with <a href="https://nixos.org/manual/nixpkgs/stable/#ssec-gnome-packaging">packaging a gnome application</a>, among other things.</p>
<p>The only thing that sticks out as related to <code>configuration</code> is the argument is <code>makeWrapper</code> <code>-add-flags "-configuration \$HOME/.eclipse/''${productId}_${productVersion}/configuration"</code>.</p>
<p>My understanding of how Eclipse works is insufficient to figure out how I would write a Nix package this MounRiver distribution &amp; also have the <code>configuation/.settings</code> it provides get used, without requiring the user to just copy these files.</p>
<p>At this point, it’s enough for me to say that the approach taken by this distributed tarball is different enough from the way Nix prefers to package things. e.g. the tarball includes a java runtime, as well as toolchain binaries for <code>make</code> and the RISC-V GCC toolchain; whereas Nix would package these separately.<br />
For myself, getting MounRiver to run is mostly a curiosity. It would have been useful for checking the WCH EVT examples. <a href="../programming/2023-12-21-notes-on-building-wch-ble-ch592-evt-exam-with-bare-makefile.html">In another blogpost, I discussed building this outside of MounRiver</a>, and in that I linked to an example with a nix-shell provided.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Okay, so in the end, I was able to run the MounRiver Studio binary on NixOS. This required using <code>nix-alien</code>, and figuring out which shared libraries were required to run the precompiled binaries. – This was a bit annoying, but not insurmountable. Getting it to run with <code>nix-alien</code> was essentially no more difficult than the hello-world example in the previous blogpost.</p>
<p>I was not able to successfully write a nix package for MounRiver Studio such that the user experience was the same “just works” as is intended. The point here seems to be:</p>
<ul>
<li><p>It seems the idiosyncracy of the eclipse home being read only caused issues reading the settings.</p></li>
<li><p>Understanding of how to work around issues like these may require a deep understanding of what the program is doing in order to work around them.</p></li>
</ul>
<p>In my experience, cases like this are not common on NixOS, and it doesn’t dissuade me at all from using NixOS. However, this is also additional effort that you probably don’t have to expend on other Linux distributions.</p>]]></summary>
</entry>
<entry>
    <title>Example of Cannot Execute Required File Not Found on NixOS</title>
    <link href="http://www.rgoulter.com/blog//posts/programming/2024-05-22-example-of-cannot-execute-required-file-not-found-on-nixos.html" />
    <id>http://www.rgoulter.com/blog//posts/programming/2024-05-22-example-of-cannot-execute-required-file-not-found-on-nixos.html</id>
    <published>2024-05-22T00:00:00Z</published>
    <updated>2024-05-22T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>One of the problems many NixOS users encounter is difficulty running binaries which have been compiled on other Linux systems.</p>
<p>The error message from trying is typically:</p>
<pre><code>cannot execute: required file not found</code></pre>
<p>which is confusing because the file is right there.</p>
<p>In this post, I’ll walk through a “hello world” example, which hopefully illustrates what’s going on.</p>
<h3 id="quickly-entering-non-nixos-from-nixos">Quickly Entering non-NixOS from NixOS</h3>
<p>A simple example of this is a “hello world” C program compiled on a non-NixOS system.</p>
<p>From NixOS, we can still enter a non-NixOS system easily using <a href="https://github.com/89luca89/distrobox">distrobox</a>.
(Distrobox is similar to <a href="https://docs.fedoraproject.org/en-US/fedora-silverblue/toolbox/">Fedora’s toolbox</a>; it lets you easily work with your HOME directory from within a container, which can be useful for OSs like NixOS or Fedora Silverblue).</p>
<p>Distrobox requires docker or podman; so, ensure that’s enabled:</p>
<pre><code>virtualisation.podman.enable = true;</code></pre>
<p>e.g. should be able to run:</p>
<pre><code>podman version</code></pre>
<p>Then we can run distrobox &amp; create an ubuntu distrobox with:</p>
<pre><code>$ nix shell nixpkgs#distrobox

$ distrobox create ubuntu --image ubuntu:latest</code></pre>
<p>And enter this with <code>distrobox enter ubuntu</code>.</p>
<h3 id="building-hello-world-in-the-ubuntu-distrobox">Building Hello World in the Ubuntu Distrobox</h3>
<p>Within the ubuntu distrobox, we install <code>build-essential</code> (since we want to compile a simple C program):</p>
<pre><code>$ sudo apt update
$ sudo apt install build-essential</code></pre>
<p>then e.g. <code>hello.c</code> (unintuitively, you can use the text editor from the host system, such as helix or neovim, even within the ubuntu distrobox):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;hello world</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And then compile this (<code>gcc hello.c</code>). And run it, if you like: <code>./a.out</code>.</p>
<h3 id="examining-a.out">Examining a.out</h3>
<p>Checking what <code>ldd</code> says about the compiled <code>hello.c</code>, from within the ubuntu distrobox:</p>
<pre><code>$ ldd ./a.out
        linux-vdso.so.1 (0x00007ffe04ff9000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fcda5200000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fcda561d000)</code></pre>
<p>and then leaving the ubuntu distrobox (e.g. <code>^D</code>), from the NixOS host we see a different result:</p>
<pre><code>$ ldd ./a.out
        linux-vdso.so.1 (0x00007ffe06e36000)
        libc.so.6 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib/libc.so.6 (0x00007f6dd47d1000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib64/ld-linux-x86-64.so.2 (0x00007f6dd49c1000)
</code></pre>
<p>Trying to run this on the NixOS host results in an error:</p>
<pre><code>$ ./a.out
bash: ./a.out: cannot execute: required file not found</code></pre>
<p>Using <code>fish</code> shell, the error is more useful:</p>
<pre><code>$ ./a.out
exec: Failed to execute process &#39;./a.out&#39;: The file exists and is executable. Check the interpreter or linker?</code></pre>
<h3 id="a-bash-script-analogy">A Bash Script Analogy</h3>
<p><code>ld-linux</code> is the <a href="https://linux.die.net/man/8/ld-linux">dynamic-linker</a>.</p>
<p>What’s going on is comparable to executing a shell script with a <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env bash</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> moo <span class="kw">|</span> <span class="ex">cowsay</span></span></code></pre></div>
<p>If we have an executable script with a bad interpreter, e.g. <code>badinterp</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/nonexist</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;hello&quot;</span></span></code></pre></div>
<p>Then trying to run this with <code>bash</code> yields the same “required file not found” error:</p>
<pre><code>$ ./badinterp
bash: ./badinterp: cannot execute: required file not found</code></pre>
<p>although <code>fish</code> shell once again is more useful:</p>
<pre><code>$ ./badinterp
exec: Failed to execute process &#39;./badinterp&#39;: The file specified the interpreter &#39;/nonexist&#39;, which is not an executable command.</code></pre>
<p>If running the above executable script (e.g. <code>cowsay-moo</code>) without <code>cowsay</code> on <code>PATH</code>, we get a different error:</p>
<pre><code>$ ./cowsay-moo
./cowsay-moo: line 2: cowsay: command not found</code></pre>
<p>That the executable isn’t on the PATH is a much easier to understand.</p>
<p>The other most common kind of linker error is analogous to that:</p>
<pre><code>error while loading shared libraries: libz.so.1: cannot open shared object file: No such file or directory</code></pre>
<p>whereas a shell uses <code>PATH</code> to find exectuables, the dynamic linker uses <code>LD_LIBRARY_PATH</code> to find dynamically linked libraries.</p>
<p>This is also why setting <code>LD_LIBRARY_PATH</code> often results in problems related to “version GLIBCXX_ not found”. – By setting the <code>LD_LIBRARY_PATH</code>, the dynamic linker loads a glibc version that’s different than what the program expects, and so runs into problems.</p>
<h3 id="working-around-the-problem-fhs-environments">Working Around the Problem: FHS Environments</h3>
<p>One workaround provided by nixpkgs is <a href="https://nixos.org/manual/nixpkgs/stable/#sec-fhs-environments">FHS environments</a>.
(These are implemented using <a href="https://github.com/containers/bubblewrap">bubblewrap</a>, which flatpak uses).</p>
<p>e.g. in this case, we can write a simple <code>fhs.nix</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>pkgs.buildFHSEnv <span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">runScript</span> <span class="op">=</span> <span class="ss">./a.out</span><span class="op">;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>and then build/run this with <code>nix-build ./fhs.nix</code>, and running <code>./result/bin/hello</code>.</p>
<p>(FWIW, this FHS env would need to be re-built every time the binary changes).</p>
<h3 id="automating-this-workaround-nix-alien">Automating this Workaround: nix-alien</h3>
<p>This approach of “write an FHS env for the unpatched binary, and run that” has been automated by the tool <a href="https://github.com/thiagokokada/nix-alien">nix-alien</a>.</p>
<p>We can add <code>nix-alien</code> to the shell with:</p>
<pre><code>$ nix shell &quot;github:thiagokokada/nix-alien#nix-alien&quot;</code></pre>
<p>and then run this with:</p>
<pre><code>$ nix-alien ./a.out
[nix-alien] File &#39;/home/rgoulter/.cache/nix-alien/f5127167-26a2-5c7d-89d0-fb363e223e43/fhs-env/default.nix&#39; created successfuly!
....
hello world</code></pre>
<p>The thing to note is that it creates this <code>.cache/nix-alien/UUID/fhs-env/default.nix</code> file.</p>
<p>NOTE: if you change the arguments to <code>nix-alien</code>, you may need to call <code>nix-alien</code> with <code>--recreate</code> to ensure it recreates the <code>default.nix</code>.</p>
<p>Examining the <code>default.nix</code> it creates:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="bu">builtins</span>.<span class="bu">fetchTarball</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;nixpkgs-unstable-20240509145238&quot;</span><span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>      <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;https://github.com/NixOS/nixpkgs/archive/f1010e0469db743d14519a1efd37e23f8513d714.tar.gz&quot;</span><span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;sha256-doPgfj+7FFe9rfzWo1siAV2mVCasW+Bh8I1cToAXEE4=&quot;</span><span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="op">}</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">inherit</span> (<span class="va">pkgs</span>) <span class="va">buildFHSUserEnv</span>;</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>buildFHSUserEnv <span class="op">{</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;a.out-fhs&quot;</span><span class="op">;</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="va">targetPkgs</span> <span class="op">=</span> <span class="va">p</span><span class="op">:</span> <span class="kw">with</span> p<span class="op">;</span> <span class="op">[</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="va">runScript</span> <span class="op">=</span> <span class="st">&quot;/home/rgoulter/playground/distrobox-build/a.out&quot;</span><span class="op">;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>builtins.fetchTarball</code> is essentially performing the same role as <code>&lt;nixpkgs&gt;</code>. (The latter uses <code>nixpkgs</code> on <code>NIX_PATH</code>, the former uses a particular revision of the <code>nixpkgs</code> repository).</p>
<p><code>buildFHSUserEnv</code> is an alias for <code>buildFHSEnv</code>.</p>
<p><code>targetPkgs</code> is empty (so doesn’t have any effect on this example), but it’s useful for additional dynamically linked libraries the precompiled binary may need.</p>
<h3 id="a-universal-nixos-workaround">A Universal NixOS Workaround:</h3>
<p>Another solution, which works in some cases where <code>buildFHSEnv</code> does not, is <a href="https://github.com/Mic92/nix-ld">nix-ld</a>.</p>
<p>This can be enabled by updating your NixOS config with:</p>
<pre><code>  programs.nix-ld.enable = true;</code></pre>
<p>Directly running the same binary again leads to a different error message:</p>
<pre><code>$ ./a.out
cannot execute ./a.out: You are trying to run an unpatched binary on nixos, but you have not configured NIX_LD or NIX_LD_x86_64-linux. See https://github.com/Mic92/nix-ld for more details</code></pre>
<p>As the nix-ld readme suggests, we can set <code>NIX_LD</code> with a <code>shell.nix</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pkgs.mkShell <span class="op">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">NIX_LD_LIBRARY_PATH</span> <span class="op">=</span> pkgs.lib.makeLibraryPath <span class="op">[];</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">NIX_LD</span> <span class="op">=</span> pkgs.lib.fileContents <span class="st">&quot;</span><span class="sc">${</span>pkgs.stdenv.cc<span class="sc">}</span><span class="st">/nix-support/dynamic-linker&quot;</span><span class="op">;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>entering this with <code>nix-shell</code>, and running this:</p>
<pre><code>$ ./a.out
hello world</code></pre>
<h3 id="another-workaround-patchelf">Another Workaround: patchelf</h3>
<p>Another way to work around the program is to just patch the binary directly.
(This is typically how precompiled binaries are handled in nixpkgs packages).</p>
<p>This can be done with <a href="https://github.com/NixOS/patchelf">patchelf</a>. Again, adding it to PATH with:</p>
<pre><code>nix shell nixpkgs#patchelf</code></pre>
<p>then e.g. copying the interpreter from the output of <code>ldd</code> above:</p>
<pre><code>$ patchelf --set-interpreter /nix/store/anlf335xlh41yjhm114swi87406mq5pw-glibc-2.38-44/lib64/ld-linux-x86-64.so.2 ./a.out</code></pre>
<p>and running the binary:</p>
<pre><code>$ ./a.out
hello world</code></pre>
<h4 id="automatic-patchelf-in-nix-packaging-autopatchelfhook">Automatic patchelf in Nix Packaging: autoPatchelfHook</h4>
<p>When writing Nix packages, nixpkgs has an <a href="https://nixos.org/manual/nixpkgs/stable/#setup-hook-autopatchelfhook">autoPatchelfHook</a> which can take care of automatically performing tasks like this.</p>
<p>This makes more sense when packaging a prebuilt release of some program, but we can still apply it to this prebuilt <code>./a.out</code>:</p>
<p>e.g. a <code>hello.nix</code> file with:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>pkgs.stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">pname</span> <span class="op">=</span> <span class="st">&quot;hello-world&quot;</span><span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;1.0.0&quot;</span><span class="op">;</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    pkgs.autoPatchelfHook</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">dontUnpack</span><span class="op">=</span><span class="cn">true</span><span class="op">;</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">installPhase</span><span class="op">=</span><span class="st">&#39;&#39;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="st">    mkdir -p $out/bin</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="st">    cp </span><span class="sc">${</span><span class="ss">./a.out</span><span class="sc">}</span><span class="st"> $out/bin/hello</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="st">  &#39;&#39;</span><span class="op">;</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>this can be built with <code>nix-build hello.nix</code> and the resulting patched binary run with <code>./result/bin/hello</code>.</p>
<p>The <code>autoPatchelfHook</code> is invoked as part of the ‘fixup’ phase.</p>]]></summary>
</entry>
<entry>
    <title>Experience Updating the C Worksheet Project</title>
    <link href="http://www.rgoulter.com/blog//posts/programming/2024-05-18-experience-updating-the-c-worksheet-project.html" />
    <id>http://www.rgoulter.com/blog//posts/programming/2024-05-18-experience-updating-the-c-worksheet-project.html</id>
    <published>2024-05-18T00:00:00Z</published>
    <updated>2024-05-18T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>Around a decade ago, I made a <a href="https://github.com/rgoulter/c-worksheet.vim">pretty neat project</a>:
a “worksheet” user interface for simple C programs. – By executing the worksheet, you get to see the program’s
output annotated alongside the source code.</p>
<p>An illustrative example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">*</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> x <span class="op">=</span> <span class="dv">5</span><span class="op">;</span>                                      <span class="co">//&gt; x is int</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> <span class="op">*</span>px<span class="op">;</span>                                        <span class="co">//&gt; px is pointer to int</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  px <span class="op">=</span> <span class="op">&amp;</span>x<span class="op">;</span>                                        <span class="co">//&gt; px = 0x7ffc365efd5c = 5</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>px <span class="op">=</span> <span class="dv">3</span><span class="op">;</span>                                        <span class="co">//&gt; (*px) = 3</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  x<span class="op">;</span>                                              <span class="co">//&gt; 3</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  px <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>                                         <span class="co">//&gt; px = (nil)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>px <span class="op">=</span> <span class="dv">5</span><span class="op">;</span>                                        <span class="co">//&gt; SEGFAULT</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  x<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;done.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>//&gt;</code> comments are automatically generated by the worksheet program.</p>
<p><a href="https://github.com/rgoulter/c-worksheet-instrumentor/?tab=readme-ov-file#worksheet-examples">More examples on the c-worksheet-instrumentor readme</a>.</p>
<p>The project consists of a “c-worksheet” program which does all the heavy lifting of computing the C worksheet annotations, and a vim plugin which provides a nice UI for using the worksheet functionality.</p>
<p>I recently performed some maintenance on it to bring it up to scratch, &amp; to check that it’s in working condition.</p>
<p>You’d hope untouched code would stay working. – Nothing changed, so nothing should have broken.<br />
In reality, since the project dependencies constantly get updated (e.g. library dependencies, and system tools), some code needed to change in order to build the code from source.</p>
<p>Logging some thoughts here:</p>
<h2 id="updating-the-c-worksheet-instrumentor-scala-project">Updating the C Worksheet Instrumentor (Scala Project)</h2>
<p>The “C Worksheet Instrumentor” is the Scala part of the project which does the heavy work.</p>
<p>Overall, the changes I made involved:</p>
<ul>
<li><p>Getting the project to build again:</p>
<ul>
<li><p>Updating the <code>build.gradle</code> file to work with recent gradle releases.</p></li>
<li><p>Updating the dependency library versions from Scala 2.11 to Scala 2.12.</p></li>
</ul></li>
<li><p>Updating CI: Fixing mistakes in AppVeyor, removing TravisCI, and adding GitHub Actions support.</p></li>
<li><p>Upon this foundation, some more minor polishing:</p>
<ul>
<li><p>Adding files to work with the Nix package manager.</p></li>
<li><p>Tree-wide automated formatting of the codebase.</p></li>
</ul></li>
</ul>
<p>Most of the project was written in 2015 as part of my undergraduate dissertation.<br />
Since then, I did add CI/CD jobs to the project in 2018.</p>
<p>Implementation-wise:<br />
This “C worksheet instrumentor” project was implemented using Scala, &amp; a parser written with Antlr (which generates Java code from a grammar definition file). The tests were written using ScalaTest.</p>
<p>This tech stack is different-enough from “only Scala files” so as to make setting up the build files annoying.</p>
<p>For building this, I used gradle.</p>
<p>For Scala, I think the SBT (Scala Build Tool) is more common. <a href="../programming/2015-01-19-gradle-or-sbt.html">I wrote about my frustrations trying to set up the project with either back then</a>. (Since then, I moved to use gradle; I think because I was able to add a ProGuard configuration to gradle, but didn’t for SBT).<br />
– I wish I could say my conclusion of “they both suck” was sophomoric. Perhaps “they’re both painful to set up” would be a more precise and tactful way of expressing it.</p>
<h3 id="updating-gradle">Updating Gradle</h3>
<p>In this case, where the <a href="https://github.com/rgoulter/c-worksheet-instrumentor/commits/master/build.gradle">build.gradle file was written in mid-2015</a>, the up to date release of gradle <a href="https://gradle.org/releases/">would have been v2.3; whereas at the time of writing, it’s Gradle 8.7</a>.<br />
– I wasn’t able to use gradle 8.7 to run this old gradle file.</p>
<p>I’ve since learned Gradle tooling itself does have solutions for “different projects depend on different gradle versions”: gradle supports generating a <a href="https://docs.gradle.org/current/userguide/gradle_wrapper_basics.html">“gradle wrapper” script</a>. This wrapper script will download &amp; invoke the appropriate gradle version.<br />
However, for my codebase, using a gradle wrapper generated by gradle 2.3 still ran into some problems:<br />
I couldn’t successfully run the gradle 2.3 wrapper using jdk 21. Not a big deal.<br />
Using jdk 8, I managed to at least build the project; but the tests failed due to a classpath error. (Presumably a transitive dependency updated with a requirement for a more recent Gradle version. – There wasn’t a lockfile of versions used; although <a href="https://docs.gradle.org/6.8/release-notes.html#dependency-management-improvements">Gradle apparently introduced this feature in Gradle 6.8</a>).</p>
<p>Anyway.<br />
Since the code didn’t build, I stripped the <code>build.gradle</code> file down to its basics in order to get <em>something</em> to build.<br />
Previously, I had added code to the <code>build.gradle</code> related to shadowjar and proguard. (shadowjar would help to bundle dependency JARs all into one JAR file, and proguard could assemble a small JAR with stripped down dependencies). I recall adding these partly because I was frustrated with how slow the internet took to download a 20MiB JAR from GitHub Releases. And partly because I liked the idea of the distributed <code>lib/</code> dir having a single JAR.<br />
– Distributing software is hard. I knew less about that back then than I do now, I feel.</p>
<p>I was then able to get an LLM chatbot to help advise me on the changes I’d need to make to the <code>build.gradle</code> file for a more recent gradle.<br />
e.g. it was able to explain to me to change from <code>jcenter()</code> to <code>mavenCentral()</code>, and syntax changes to the <code>dependencies {}</code> and <code>jar {}</code> blocks. This saves several minutes of time &amp; a search or two.</p>
<p>And since Scala 2.11 didn’t run with a recent Java Runtime Environment, I updated the code (and matching dependencies) to Scala 2.12.</p>
<p>In the end: <a href="https://github.com/rgoulter/c-worksheet-instrumentor/compare/cdd47b185df9690f9f5dde78d8f596b5c2af2296..74ceb4c1558450355488431bafe126641c0c480b">diff of changes to get the code to build</a>.</p>
<h3 id="updating-ci">Updating CI</h3>
<p>One thing I did do well with this project was to have a fairly good test suite.</p>
<p>I’d left the project in a state where it had CI jobs running on Travis CI, and on Appveyor.</p>
<p>I do appreciate that these CI services often will let you run jobs for free, if your repository is public.</p>
<p>The CI jobs I have for this project are almost trivial: install dependencies &amp; check that <code>gradle build</code> runs.</p>
<p>In the years since, Travis CI stopped running my jobs. So, I moved the builds for Linux/macOS to GitHub Actions.</p>
<p>The builds failed AppVeyor due to Java version issues.<br />
I got stuck for a moment since AppVeyor wasn’t reading the <code>appveyor.yml</code> file for build details. Deleting/recreating the AppVeyor sorted things out. (It had been something to do with AppVeyor’s behaviour for arbitrary git projects vs for GitHub-linked projects).</p>
<h3 id="adding-nix">Adding Nix</h3>
<p>The <a href="https://nixos.org/">nix package manager</a> has been a valuable tool to learn. It’s got a steep learning curve, but it’s very good at dealing with problems related to packaging. (Which, for developers, turns out to be <em>a lot</em>).</p>
<p>One of the ways that writing CI/CD can be frustrating is for cases where something works locally, but figuring out how to run it on a fresh host can be frustrating.<br />
With nix, this isn’t an issue. – Indeed, the CI/CD job I added which used nix really is trivial: it installs nix, and then runs <code>nix build .</code>.</p>
<p>Another advantage with Nix is easy setup for isolated development environments. I remember reading blogposts like “my development setup for <lang>”. These days, it’s pretty much “a formatter, a linter, a language server”. Using a <code>shell.nix</code> means it’s easy to make these tools available (i.e. installed) when working on the project.</p>
<p>The difficulty I ran into adding Nix support for the project was due to differences between how gradle wants to manage dependencies, vs how nix wants to. Searching through the nixpkgs codebase, a common approach is to use some kind of <a href="https://nixos.org/manual/nixpkgs/stable/#maven">Fixed Output Derivation deps pattern</a> in order to deal with the idiosyncracies of each. (Also, gradle uses <code>~/.gradle</code>, and nix builds its packages with <code>HOME</code> set to a non-existant directory, so the <code>gradle.user.home</code> had to be explicitly set to avoid issues).</p>
<h3 id="minor-polishing">Minor Polishing</h3>
<p>With the code building from source, and CI/CD in working state so as to run the build/tests for each commit, changes can be made with the confidence that if anything breaks, CI/CD will be able to catch problems.</p>
<p>I spent time to add an “End to End” integration test: a test which called the command line program, and checked the results of the output. This was an improvement over the existing test suite, which ran the Scala code in-process.</p>
<p>I also noticed that some tests failed when running on macOS where <code>cc</code> defaults to <code>clang</code>.<br />
Turns out, some of the Worksheet functionality works with GCC but not Clang.<br />
So, I refactored the tests so that the relevant parts of the test suite could be run with either GCC or with Clang.</p>
<p>Another polish to add to the project was using <code>scalafmt</code> to ensure consistent code formatting across the project.</p>
<h3 id="chatbot-llms-often-useful">Chatbot LLMs Often Useful</h3>
<p>As mentioned, I found a chatbot LLM to be useful for helping to update the code.</p>
<p>To be honest, tasks like “update CI/CD” or “update the build file” are not glamorous: they might require knowing a fair amount about the tools, but the tools provide limited value.<br />
(Whereas e.g. Nix is a powerful tool which lends itself to use cases outside of just “build this project”, and so is worth taking the time to learn).<br />
– For these tasks, using chatbot LLMs helps make progress without having to spend a long time learning the tool.</p>
<p>e.g. Since gradle files are written with the Groovy language (a Ruby-ish JVM language), and this is the only use of Groovy I have, it’s quicker to ask a chatbot “please write the Groovy code to…” than to spend time looking up Groovy syntax, and what methods Groovy lists have.</p>
<p>Where I found it limited, with the LLM I was chatting with, was when I was asking a dumb question (trying something that goes against the grain of a tool’s approach), the chatbot was more inclined to give me an answer that sounded helpful, than to push back and say “no, it doesn’t work that way”.</p>
<h3 id="lost-context-and-knowledge">Lost Context and Knowledge</h3>
<p>Working on a project so intermittently means you suffer from losing context/knowledge of various parts of it.</p>
<p>Phrasing this in terms of risk and change: using something more unusual means there’s a higher risk that it’s more difficult to change if you need to.</p>
<p>The more implicit and magical something is, the harder it is to identify.</p>
<p>Scala is a complex language with a wide variety of sophisticated features.<br />
I haven’t had to change the Scala codebase all that much. However, I do appreciate its ‘sophisticated’ features, such as the pattern matching, and named arguments.</p>
<h2 id="updating-the-vim-plugin">Updating the Vim Plugin</h2>
<p>The C Worksheet is a neat idea, but it only really sense for the UI to be part of a text editor (rather than just listing annotated output on the command line).</p>
<p>I had written <a href="https://github.com/rgoulter/c-worksheet.vim">c-worksheet.vim</a> back in 2015.</p>
<p>Implementation-wise:<br />
The meat of the code was fairly straightforward: rather than leaning on vimscript, I used vim’s python commands in order to invoke Python code; and that Python code managed the interface between the Vim source and the c-worksheet output.</p>
<p>The upside to using vim’s python integration was not having to wrangle with vimscript to figure out how to interface it with the Scala program.<br />
The downside was that it was affected by Python’s less-than-smooth transition from Python 2 to Python 3.</p>
<p>In 2015, it was fine to use the python2 <code>pyeval</code>. In 2024, I needed to use the python3 <code>py3eval</code>.</p>
<p>Other than updating the Python code, the rest of the vimscript fortunately still worked. +1 to vim’s support backwards compatability.</p>
<p>I saw that Vim has a new native package management functionality, with commands like <code>:packadd</code>.<br />
However, I was using the <code>autoload</code> feature to defer loading much of my plugin’s loading, and using <code>ftplugin/c/</code> in order to provide my plugin functionality to C files.. – Using <code>:packadd</code> is also a way of deferring when code gets loaded; but by loading the package when opening a C file, it wouldn’t then also load my plugin.<br />
– The intricacies of how vim loads its vimscript is something I didn’t entirely recall. (Albeit, I’ve moved on to using Doom Emacs as my primary editor).</p>
<p>After updating the code, I took the time to write a few tests for the code.<br />
In this case, integration tests that checked the plugin could run <code>c-worksheet</code> against a “Hello World” source file. (And some non-functional tests to check that the plugin behaves if the <code>c-worksheet</code> program isn’t available).</p>
<p>The main trouble I had with this was trying to setup CI/CD with Windows.<br />
The computer I use for day to day things is Linux. I happen to have Windows installed on another partition; but, I’m not very familiar with the Windows command line.<br />
(And also, Vim’s batch mode didn’t behave well on Windows; I was able to set up the tests using Neovim, but not Vim).</p>
<p>With hindsight, there are things I wish I’d done better. The code could have been written more defensively: e.g. <code>pyeval</code> is gated behind vim’s <code>python2</code> option. My code doesn’t guard against this. Nor does it guard against whether the <code>c-worksheet</code> command can be run. And its ‘service management’ is naive/sloppy; the interface with the C Worksheet Instrumentor is also naive/sloppy. – The code was clearly thrown together to the level of “it’s at least useful in some cases”, rather than “it’s cleanly and robustly useful in as many cases as it can be”.</p>]]></summary>
</entry>
<entry>
    <title>Finally Playing Medal of Honor Airborne</title>
    <link href="http://www.rgoulter.com/blog//posts/games/2024-05-17-finally-playing-medal-of-honor-airborne.html" />
    <id>http://www.rgoulter.com/blog//posts/games/2024-05-17-finally-playing-medal-of-honor-airborne.html</id>
    <published>2024-05-17T00:00:00Z</published>
    <updated>2024-05-17T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I’d bought “Medal of Honor Airborne” on Steam many years ago, but had been unable to play it. Something about compatibility with my graphics card.<br />
My desktop runs Linux these days; Valve’s Proton works pretty well for Windows games, and ProtonDB said that MoHA ran just fine. So, I was able to give it a go.<br />
It more/less worked! Albeit, the game was frequently laggy (and occasionally crashed).</p>
<p>Mostly I didn’t like the game. Here’s what I thought of it:</p>
<h2 id="parachuting-and-its-effect-on-level-design">Parachuting and its Effect on Level Design</h2>
<p>The game is set during WW2, and you play as an American paratrooper.<br />
This enables the game’s key ‘gimmick’: when you start the mission, you parachute into the mission.</p>
<p>The levels are then designed in two parts: the first half is a somewhat open map you parachute into, and the second half is a more traditional/linear experience.<br />
Optimistically, this is a nice way to hedge a potentially risky game design choice: since the second half of each mission reverts to the traditional linear gameplay style, then at least there’s that if the parachuting mechanics don’t work well. (Pessimistically, it’s a conflict of design vision).</p>
<p>The “parachute into the level” still feels relatively unique for mission-focused single-player shooter games.<br />
e.g. multiplayer games like Battlefield feature parachuting.. and it’s a strategic aspect of the “battle royale” games like PUBG or Fortnite, etc.<br />
The Just Cause series features the player being able to fly around; but Just Cause is an open world game through to its heart, and its missions are a light layer on top.</p>
<p>To an extent, “well crafted experience” conflicts with “open world sandbox”.<br />
Medal of Honor generally prefers to aim for the cinematic former.</p>
<p>In MoHA, the level design ends up having a very open start, which branches off into more linear chunks where the player completes each objective. (e.g. “destroy the ammo cache” will be its own linear segment of a level; and “clear the anti air defenses” will be a separate linear segment).</p>
<p>In some cases, the player can parachute right to the end of one of these segments; but, the mission objectives are heavily defended, and then you don’t get to parachute into the next objective either.</p>
<p>Overall.. I thought this was a pretty neat game mechanic.<br />
I don’t think it adds enough to the game to be worth implementing.</p>
<h2 id="downsides-to-the-parachuting-as-implemented-checkpoints-and-progress">Downsides to the Parachuting as Implemented: Checkpoints and Progress</h2>
<p>As it’s implemented in MoHA, the parachuting did lead to some frustrating gameplay, or at least how it interacted with checkpoints.</p>
<p>Checkpoints are based on completing objectives.<br />
If you die before completing the (initial) objectives, you’ll parachute into the level again.<br />
And all the enemies on the map respawn.<br />
AFAICT, enemies continuously spawn (up to a limit), based on ‘morale’.<br />
– This wasn’t immediately clear to me, but it did frustrate me a bit. It meant that I might spend a significant amount of time killing enemies and making progress, only to have that all undone if I died before reaching an objective. (In contrast, if there are two objectives close together, you can get checkpoints very quickly).</p>
<p>If there were a finite number of enemies, then this wouldn’t run into the same frustration. As is, it means that “turtling” is just the wrong way to play the game.<br />
If checkpoints were more frequent, this wouldn’t run into the same frustration.</p>
<h2 id="shooter-mechanics">Shooter Mechanics</h2>
<p>These felt a bit clunky to me.</p>
<p>The first thing that seemed clunky was the ammo.<br />
In the earlier Medal of Honor Allied Assault, enemies drop ammo for the guns they use. An enemy with a rifle drops rifle ammo, an enemy with a submachine gun drops submachine gun ammo. You didn’t get to swap to use <em>their</em> rifle.<br />
In MoHA, the drops from enemies seem random. They might drop their weapon, in which case you can swap to use that. You don’t pick up ammo for your rifle from their rifle. They might drop health. They probably don’t drop anything at all.</p>
<p>But since the enemies continuously spawn (until pushed back), this meant my initial experience with the game was running out of ammo shooting at the enemies, and not being able to find ammo pickups.</p>
<p>The game does compensate for this by giving your pistol infinite ammunition.</p>
<p>You avoid these problems by taking a somewhat more aggressive approach:<br />
By pushing up, the enemies will ‘retreat’; once pushed back to the objective, the enemies stop respawning.</p>
<p>The most strikingly clunky thing about the game (compared to shooters since) is the “aim down sights” mechanic.. the intended use is for the player to use this behind cover, and then peek around cover to shoot enemies. For this, the game keeps the player standing, and the movement keys are used for ‘peek’.<br />
In practice, players will want to move about while using this ADS. MoHA supports this, but it’s not the default, so it feels clunky.</p>
<h2 id="the-flow-when-it-worked">The Flow, When it Worked</h2>
<p>Once I figured out the idiosyncrasies.. the gameplay loop that ended up mostly working was reasonable: rush up to cover near an enemy (or ideally, to a position which flanks the enemy), do the shooting while trying to not get shot, rinse &amp; repeat.</p>
<h2 id="rocket-spam-from-enemies-got-tiring-quickly">Rocket Spam from Enemies Got Tiring Quickly</h2>
<p>There are enemies with rocket launchers.<br />
These would spam rockets, which I found annoying.<br />
I found this particularly obnoxious because there was such a high duration between checkpoints.</p>
<h2 id="story">Story</h2>
<p>The game has a weird mix of tone.</p>
<p>Videogames are supposed to be fun. (Except maybe the pretentious artsy bullshit ones). War and history is horrible.<br />
So, games with historical parts aren’t going to be fully realistic. Some games aim to be simulations, some aim to be more arcade-like.</p>
<p>I reckon the game series that had a great balance between arcade and realistic is “Brothers in Arms”.<br />
BiA’s is a tactical shooter.. in the sense that you can’t just run up and shoot the enemies; it’s ‘tactical’ in the sense that the levels are designed around the idea of using your squad’s fire team and assault teams to suppress and flank enemy positions.<br />
Rather than “1 man vs 100 soldiers”, it’s closer to “6 soldiers vs 5 soldiers; then another 5 soldiers; and another 5 soldiers”.<br />
Regarding history, the level design mimicks the after-action reports from the fight themselves. So reading the AAR feels familiar.<br />
Regarding story.. by being very <em>subtle</em>, the game is much more impactful about your squadmates dying.</p>
<p>The story of MoHA is very “cheesy war movie” in its tone.<br />
It has no weight because the gameplay is so unrelated.<br />
At the start of every mission, the plane you fly in gets shot and its engines are on fire. Because that’s what happens in war movies.<br />
But there’s never any consequence to this.. so you get this “ludo-narrative dissonance”. The conflict between the game (where there’s no risk) vs the story (where it’s super risky).<br />
– Whereas, there are ways to ‘marry’ the gameplay and the story. e.g. in Far Cry 5, as you progress through the story, you get kidnapped by the henchmen of the boss in each region. For the boss with the theme “illusion of control”, the gameplay allows you to (temporarily) defer the kidnapping; giving you the illusion that you have more control than you really have.</p>
<p>MoHA’s battlefield is constantly filled with noisy combat; dozens of soldiers in every direction. NPC allies constantly getting gunned down, in game and in cutscenes.<br />
It has no weight at all.<br />
NPC allies just feel like “progress markers” more than anything else.</p>
<p>I guess some would say MoHA is realistic in the sense that you can’t just run and gun here, either.<br />
But, say, your pistol has infinite ammo, you can start missions with a loadout of German weapons, there are enemies which spam an endless stream of rockets at you, and enemies who carry MG42s and have ‘bulletproof’ gas masks or something.</p>]]></summary>
</entry>
<entry>
    <title>The Three Difficult Things about Nix</title>
    <link href="http://www.rgoulter.com/blog//posts/programming/2024-05-09-the-three-difficult-things-about-nix.html" />
    <id>http://www.rgoulter.com/blog//posts/programming/2024-05-09-the-three-difficult-things-about-nix.html</id>
    <published>2024-05-09T00:00:00Z</published>
    <updated>2024-05-09T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p><a href="https://nixos.org/">Nix</a> is a fancy package manager, with a bunch of powerful features.</p>
<p>One thing it’s notorious for is its steep learning curve.</p>
<p>Although generally, learning to write Nix code is difficult for the same reasons a lot of other tech is difficult (e.g. you have to be aware of what’s possible, and unfamiliar things are always going to be have friction compared to what’s familiar), I reckon there are a bit more specifically three reasons why Nix is difficult.</p>
<p>Any difficulty someone is having when trying to use Nix almost always falls into one of:</p>
<ol type="1">
<li><p>difficulty with the Nix package manager itself.</p></li>
<li><p>difficulty with the Nixpkgs codebase.</p></li>
<li><p>difficulty with software and how it mixes with Nix’s approach.</p></li>
</ol>
<p>Discussing this a bit more:</p>
<h2 id="three-difficulties">Three Difficulties</h2>
<h3 id="difficulty-with-the-nix-package-manager-itself">Difficulty with the Nix Package Manager Itself</h3>
<p>When learning about Docker, you’ll need to learn about the difference between an “image” and a “container”.</p>
<p>Or when learning Terraform, you need to build an intuition for how the providers model and manipulate the resources being declared.</p>
<p>With the Nix package manager, there are also a bunch of concepts to learn.</p>
<p>Nix’s approach to package management is quite different to how traditional package managers have done things. So, with Nix, you end up bumping into weird terms like “derivation”, “instantiate”, “realise”.</p>
<p>I disagree with many who say things like “I like the idea of Nix, but wish I could write it in JavaScript”. The Nix expression language is <em>essentially</em> a “JSON + function (+ imports)”, similar to languages like Jsonnet (which I don’t hear the same complaints about).<br />
But, I agree it’s fair to say that the Nix expression language’s laziness can lead to code that’s very “clever” (and hard to read). And concepts like “partially applying a function” are common in functional programming, and unusual/exotic otherwise.<br />
And e.g. it took me some time to wrap my head around why many Nix files would open with <code>{ pkgs ? import &lt;nixpkgs&gt; {} }:</code>.</p>
<p>Much of the community has adopted use of Nix Flakes.<br />
There are several things about flakes that are not very ergonomic, and not all that intuitive, although overall I think they’re not too difficult to understand, and using flakes comes with more benefits than disadvantages.</p>
<h3 id="difficulty-with-the-nixpkgs-codebase">Difficulty with the Nixpkgs Codebase</h3>
<p>Nixpkgs is somewhat comparable to the “standard library” of Nix.</p>
<p>A lot of Nix code will typically use common functions in nixpkgs. e.g. functions like <code>pkgs.mkShell</code> or <code>buildPythonPackage</code> <a href="https://wiki.nixos.org/wiki/Python">on the NixOS wiki page for Python</a> are a part of the nixpkgs codebase.</p>
<p>Nixpkgs is a large codebase. It’s not immediately clear what’s useful and available. As you dive deeper into Nixpkgs, you quickly see it’s filled with a mixture of similar-but-different and often “clever” solutions to similar problems.</p>
<p>I think this is responsible for a lot of difficulty with <em>writing</em> Nix code. (Although I think e.g. <a href="https://nix.dev/">nix.dev</a> now does a lot to ease over the rough edges of getting started).</p>
<p>If you provided <code>pkgs.mkShell</code> in JavaScript, it would still be confusing to use.</p>
<p>It can be difficult to figure out how to properly access and manipulate code in nixpkgs.</p>
<p>The <code>lib.customisation</code> <a href="https://nixos.org/manual/nixpkgs/stable/#sec-functions-library-customisation">lib functions</a> are both confusing to understand and related to <code>.override</code> and <code>.callPackage</code> functions which are extremely common when dealing with Nix packages.</p>
<h3 id="difficulty-with-software-and-how-it-mixes-with-nixs-approach">Difficulty with Software and How it Mixes with Nix’s Approach</h3>
<p>This sorta applies more to NixOS than to Nix. (If someone runs into problems with Nix on non-NixOS, they can always just do things without touching Nix).</p>
<p>One of the reasons Nix is difficult is that when something goes wrong, it often requires a deeper and broader understanding of what’s going, compared to other Linux systems. – You might need to understand what nix is doing, what the nixpkgs code in use is doing, or what the system-under-nix is doing.</p>
<p>As a novice programmer, I could get by with copying and pasting snippets from StackOverflow (after searching for whatever error message I encountered). – Not so if you run into problems when on NixOS!</p>
<p>Nix doesn’t <em>replace</em> other Linux things (like <code>make</code>), so much as it uses them in an uncommon way. – I recall reading a comment where someone’s cold shower against Nix hype was that it was “just” using <code>make</code> &amp; symlinks. – Nix and NixOS mean an additional layer that may need to be understood.</p>
<p>Probably the most common example of this problem is that it’s difficult to run pre-built binaries on NixOS, unlike on most other Linux distributions. On other Linux systems, shared libraries get installed into a global location, and pre-built binaries are able to find these. Whereas NixOS puts shared libraries in isolated locations, so pre-built binaries don’t run without some massaging.</p>
<p>It can be extra frustrating that something is easy on other Linux distributions but may be difficult with Nix/NixOS.</p>
<h2 id="other-remarks">Other Remarks</h2>
<p>There are sometimes difficulties people run into with Nix that don’t really fit into these categories. e.g. sometimes a tool takes an approach which doesn’t map well to how Nix wants things done. But, if someone has the above difficulties covered (they’ve got a good understanding of Nix, the relevant parts of Nixpkgs, and of what the program is doing), then the problem is more likely to feel tractable.</p>
<p>Another way of putting the above difficulties is “you gotta know what you’re doing (if something goes wrong)”.<br />
And for many developers, there’s an expectation of being able to get pretty far without needing to spend a long time learning all the details. (Often this is a pretty good strategy!).</p>
<p>I think to some extent, some of that difficulty is fundamental.<br />
Nix provides benefits like “will work the same way next time you run it”, and this demands it comes with a level of strictness.</p>]]></summary>
</entry>
<entry>
    <title>A Wish for More Accessible Classic Tomb Raider-ish Games</title>
    <link href="http://www.rgoulter.com/blog//posts/games/2024-05-06-a-wish-for-more-accessible-classic-tomb-raider-ish-games.html" />
    <id>http://www.rgoulter.com/blog//posts/games/2024-05-06-a-wish-for-more-accessible-classic-tomb-raider-ish-games.html</id>
    <published>2024-05-06T00:00:00Z</published>
    <updated>2024-05-06T00:00:00Z</updated>
    <summary type="html"><![CDATA[<p>I’ve been playing through the Tomb Raider I-III Remastered collection of games.</p>
<h2 id="yay-remasters-of-old-games">Yay, Remasters of Old Games</h2>
<p>The remaster fits in with a loose trend of some classic games being remade or remastered, and re-released.</p>
<p>e.g. to my mind, the Age of Empires series did a good job with this: Age of Empires 2 got an HD re-release. After that succeeded, much effort was put into remastering Age of Empires 1, which got a “Definitive Edition” re-release. Then Age of Empires 2 got a subsequent “Definitive Edition” re-re-release, followed by several DLC expansions. Some of the changes to the game have been “Quality of Life” changes which have reduced the skill for for playing the game. (e.g. showing the build queue in the UI).<br />
The publisher Nightdive Studios are an outstanding example of quality stewardship for remastering games. I played through Turok 1 and 2 that they remastered, and they did a good job polishing these games up so they can be played on modern systems.</p>
<p>“Boomer shooters” have seen a resurgence in popularity in the last few years. The game “Cultic” is an absolutely <em>excellent</em> example of a new title which enhances the title. I think the YouTuber Civie described games like this as both respecting what made the genre popular, while also including enough to surprise and delight experienced fans of the genre.</p>
<h2 id="the-tr-remastered-collection-is-faithful-to-a-fault">The TR Remastered Collection is Faithful to a Fault</h2>
<p>Anyway.<br />
Tomb Raider Remastered.<br />
This polishes up the game so it can run on modern systems.<br />
Although most of these changes could be described as superficial (e.g. Lara’s model now looks as gorgeous as she does in the marketing materials; and the game has many Achievements to get), the Remastered game did have some changes to improve quality of life: icons will show up to indicate when Lara can interact with an item, and the game supports using a more ‘modern’ control scheme, rather than the classic ‘tank’ controls.</p>
<p>The classic Tomb Raider games are quite notorious for being hard.<br />
Well, many classic games are. (e.g. some of the Turok 2 levels are convoluted mazes to navigate through, despite the gameplay otherwise mostly focusing on shooting).<br />
But, certainly for the Tomb Raider games, I think pretty much everyone who collects all the secrets would have looked up a walkthrough at some point.</p>
<p>It’s kindof a shame that the Remaster is <em>so</em> faithful to the original so as to not add <em>more</em> quality-of-life features. I suspect that’s mostly about time/budget constraints.<br />
But, say, in the same way that there are games inspired by classic games which have good quality-of-life improvements, maybe there’s room for a similar treatment for classic Tomb Raider.</p>
<p>What I mean is:</p>
<ul>
<li><p>Gameplay with the same <em>dynamic</em> as the original.</p></li>
<li><p>Quality of life improvements.</p></li>
<li><p>Ways of lowering the skill floor, so that the game has a friendlier introduction for beginners.</p></li>
</ul>
<h2 id="definitively-tomb-raider">Definitively Tomb Raider</h2>
<p>The classic Tomb Raider games are a mix of adventure and action.<br />
The classic games also get quite scary at times.<br />
I guess different players are going to prefer different mixes of each of these.</p>
<p>e.g. The Myst games are pure adventure: there’s no combat, and it’s pretty much exploring exotic locations and solving (sometimes purely) puzzles. – If you just put Lara Croft as the protagonist in these, it still wouldn’t be “Tomb Raider”.<br />
There are some “Lara Croft” spin-off games which have twin-stick top-down shooter gameplay. These involve a lot of combat, and some puzzles. But, the level design is so smooth that you’re never going to feel lost or confused about how to make progress.</p>
<p>I think a key dynamic of the adventuring is building an understanding of the map, and engaging the player’s understanding of that.<br />
An example is TR2’s Venice level. The final half of the level involves the player having to figure out how to clear the mines to the exit, how to open the exit door, and how to raise two gates so as to be able to race from the “open exit” button to the exit. – When playing, if you’re missing any of these, you have to explore around and try different things.</p>
<p>The most antiquated yet defining part of the classic Tomb Raider games is the grid-based level design, which pairs with the “tank” controls.<br />
“Tank” controls are “pressing up moves the Player Character in the direction the Player Character is facing”. Whereas “modern” controls are more intuitive with twin-stick controllers: one stick controls the camera, the other directs the player character relative to the camera.<br />
The grid-based levels is so antiquated because it feels like the level is made out of boxes.<br />
But.. it allows for a clear set of navigation rules: Lara can reach so-and-so far by doing a standing jump, or further with a running jump. – In “modern” games like the Tomb Raider games after 2006, navigation is restricted to ledges which have been specially added onto the finely-crafted levels. These ledges stick out as relatively “shiny”, in contrast to uninteractable background details. I think that’s a step-down, since it limits the player having to reason about where to go.</p>
<p>Though, I’d also heard the difference put as: the classic TR games have a protagonist who is exaggerated; in gameplay, she’s going to die a lot as the player experiments as to how to get through the level. (TR2’s the ultimate Floating Islands is very easy to die on!). Whereas, the modern TR games are big budget, and need to be mass appeal, so can’t be as frustrating; the player is encouraged to “protect” the protagonist, and take care to prevent the protagonist from dying.</p>
<h2 id="that-sounds-like-itd-be-cool-wishlist">“That Sounds Like it’d be Cool” Wishlist</h2>
<p>I reckon it’d be neat to see some things like this; either to bring the same gameplay of the classic Tomb Raider to more modern standards, or for making the game easier (for those who need that).</p>
<p>For suggestions of things that’d make the game easier, I mostly mean in terms of “it’d be good to have an easier difficulty option”.</p>
<h3 id="pickups-and-secrets">Pickups and Secrets</h3>
<p>Some help-me quality of life features could be added to collectibles:</p>
<p>In Just Cause 3, one gameplay mechanic involves having to destroy <em>all</em> the red-painted infrastructure in a military base. At the start, this is really easy; but as you destroy more of the infrastructure, it becomes harder to find the rest of what you need to destroy. The game map compensates for this: as you destroy more, then the remaining things progressively fade in on the map.. so by the time you’ve destroyed 95% of the infrastructure, the remaining few things to destroy are clearly marked on the map.</p>
<p>Doom Eternal has several kinds of secrets and upgrades to collect.<br />
You can even upgrade your character to make it easier to find secrets!<br />
This enhances the replayability of the game: finding extra secrets makes you more powerful; and you can use that power to make it easier to get more secrets.<br />
This included “cheat codes”.. which, while they couldn’t be used when playing through the levels for progressing through the story, could make for some cathartic replays of levels.</p>
<p>In the playthroughs I’ve seen of the newer Resident Evil games, the map will colour-code whether an area has had all items picked up or not. This seems like a really neat way to guide the player.</p>
<p>I reckon ideas like this would suit classic Tomb Raider gameplay.</p>
<h3 id="combat">Combat</h3>
<p>As I see it, classic Tomb Raider’s combat is .. clunky.<br />
It works best when Lara is fighting animals (where the main ‘skill’ involves jumping around to avoid being hurt, while shooting back), and is more clumsy against armed opponents (there’s a large RNG element that dictates whether they shoot Lara or not; jumping around the level barely helps).<br />
Meshing with this is the trade-off of whether to use the weak pistols which have unlimited ammo, or use a more powerful weapon (where you might need to preserve ammo).</p>
<p>The “modern” Tomb Raider games got rid of tank controls and made the combat a somewhat typical third-person shooter; and it didn’t mix well with the rest of the game.</p>
<p>For the classic Tomb Raider style combat, I reckon some ideas that’d fit with the rest of the gameplay:</p>
<p>Halo does a good job of presenting other tradeoffs/constraints: limiting the player to choosing only two weapons, and having multiple kinds of enemies: laser guns are good vs the shields (that the enemies have), but bullet guns are better vs unshielded enemies.<br />
– I mean, this makes the choice of weapon more tactical than just “use uzis until I run out of ammo”.</p>
<p>Doom Eternal does an even better job at “action-puzzle gameplay”: you could replenish your ammo by using a chainsaw on enemies, and replenish health using ‘finisher’ moves on weak enemies. The notorious Marauder enemy would block shots, and require timing to take down.<br />
– Again, here it adds a level of engagement to combat beyond “use the shotgun until the enemy disappears”.</p>
<p>– Mechanics like these don’t coherently mesh with fighting wolves, tigers, and henchmen.. sure.<br />
But, they might make sense if fighting robots or zombies or mythical creatures.</p>
<h3 id="scares-and-horror">Scares and Horror</h3>
<p>I don’t really like scary things!</p>
<p>But on the other hand.. scary parts can be quite memorable in the Tomb Raider games.<br />
There are parts of TR2’s “Ice Palace” level that are quite scary: there’s a pitch black room, and you can hear the growls of yeti monsters. – Yet, the Remaster ‘toned down’ how scary this part was, by using lighting which illuminated the room; that undermined the point of “scary because you can’t see the room”.</p>
<p>There are parts of TR that are (deliberately) unpleasant to play because of this: threats like sharks in water sections, or there’s a dark cave full of spiders in the Temple of Xian level.</p>
<p>I think it’d be kinda neat to have the option to ‘disable’ some of those scary parts.. or, an easier modes, give the player decent tools to couch the scary parts. – e.g. Make the player stronger in water combat (&amp; without the tension-building limited ammo), or give the player a decent flashlight.</p>
<h3 id="adventure-and-puzzles">Adventure and Puzzles</h3>
<p>In terms of adventure and puzzles:<br />
IIRC, most of classic TR’s puzzles are more about ‘finding’ a key item (and so the level design ought to take you to the key and back), or are about <em>timing</em> / navigation.</p>
<p>There are few puzzles that are ‘puzzles’ to the same degree of adventure games like Myst. (Albeit, in the recent TR games, there are side-quests/dungeons which feature fairly sophisticated puzzles in this sense).</p>
<p>I think TR2’s first “Great Wall” level is a good demonstration of typical TR puzzles: the ‘challenge’ in the first area is to figure out where you’re supposed to go (&amp; the challenge of executing the jumps). The next challenge is how to get through a locked door: you dive into a small pond, find the key, get ambushed by a tiger, then make your way back up to the lock. There are secrets slightly off the main path that you can take the time to find.</p>
<p>I think the best designed TR levels are those that appear to be non-linear, but allows for a somewhat linear flow. – e.g. TR2’s “Opera House” is a daunting maze where it can be confusing to know how to progress.. kindof like a hub-and-spoke; and each spoke is a small section that unlocks access to the next spoke of the hub.</p>
<p>One of the reasons I think the grid-based level design is so central to the gameplay is you’ve got a clear, predictible, tangible logic for what the player can try to explore vs not.<br />
At the lowest level, “can I make that jump?”;
at a higher level, “have I exhausted all options in this area?”.</p>
<p>One way to make this style of gameplay easier would be to have maps that ‘hint’ at navigatable areas the player hasn’t visited.<br />
So, if a player is stuck, then looking at the map could hint at places the player can reach.<br />
Mainly I’m thinking of cases where I got stuck, and how this might have helped:<br />
e.g. one place I got stuck was TR2’s “Venice” level, where it wasn’t obvious to me that I was supposed to jump onto the bridge. The player has access to a big area, so it was easy to overlook. – I’m imagining that I could have opened a map, and seen the bridge with some kind of colour indication of “seen &amp; reachable, but not visited”.<br />
Similarly, I got stuck in TR2’s “The Deck” in the big underwater lake, by forgetting about a corridor back to the deck that I had overlooked.<br />
Or when I got stuck in TR3’s “Crash Site” by not figuring out how to get on top of the plane…
etc.</p>
<p>I mean.. sure, getting stuck is part of the experience; but “looking it up in a walthrough” is kindof a lame way of getting through, too.</p>
<p>One quality-of-life suggestion, IMO, is that level design should be almost entirely ‘reversible’.<br />
In TR, when you’re first playing a level, you’re never quite sure whether a path takes you to where you’re supposed to go, or to a secret, or to a pickup. Often in TR’s levels, once you go past some part, you can’t navigate back, which means you’d need to replay a level to get all the secrets.</p>
<p>e.g. in Doom Eternal, each map is similar to a bunch of combat arenas with platforming sections in between. It’s always possible to get back to the start from the end; and once you’ve beaten the enemies, you can also “fast travel” around the map.</p>
<h2 id="remarks">Remarks</h2>
<p>I think, if you squint, the games from Crystal Dynamics do implement some of these things.<br />
e.g. Rise of the Tomb Raider leaned into its combat, and had alternate modes which enhanced replayability.<br />
Or the TRL/TRA had cheat codes.<br />
e.g. TRU had a “Treasure Hunt” mode where you could explore through a level, after killing enemies.</p>
<p>But, as I recall, it’s more about what they add that takes away from having the same feeling as classic TR.<br />
e.g. by having a headset and chatting with others.. it detracts from “player mastering the level”, or really “player vs the environment”.<br />
e.g. by having combat and navigation be such disparate systems, the player gets a feeling of when they’ll be fighting vs when they’ll be navigating ledges.<br />
e.g. RotTR, SotTR were semi-open-world-ish at times, “as was the style at the time”.
e.g. levels are linear enough that you rarely feel “stuck” in a large enough arena.</p>
<p>Seems like the TRLE community has worked to keep the classic games alive.</p>
<p>I also remember playing Indiana Jones and the Infernal Machine, which had gameplay kinda-sorta similar to the classic Tomb Raider games.</p>]]></summary>
</entry>
<entry>
    <title>Using Terraform to Manage an Object Stored in OpenStack Swift</title>
    <link href="http://www.rgoulter.com/blog//posts/programming/2024-04-09-using-terraform-to-manage-an-object-stored-in-openstack-swift.html" />
    <id>http://www.rgoulter.com/blog//posts/programming/2024-04-09-using-terraform-to-manage-an-object-stored-in-openstack-swift.html</id>
    <published>2024-04-09T00:00:00Z</published>
    <updated>2024-04-09T00:00:00Z</updated>
    <summary type="html"><![CDATA[<h2 id="technologies">Technologies</h2>
<p><a href="https://www.openstack.org/">OpenStack</a> is a set of software that infrastructure providers can use to give users a user-experience similar to that of AWS or other cloud providers. e.g. <a href="https://cleura.com/">Cleura</a> provides a public cloud service which can be managed with OpenStack APIs. – I think the idea for OpenStack was to enable infrastructure providers to serve as a substitute for AWS.. albeit, even amongst OpenStack public clouds, there remain idiosyncracies such that a deployment in one OpenStack cloud might require effort to deploy to another OpenStack cloud.</p>
<p><a href="https://docs.openstack.org/swift/latest/">OpenStack’s Swift</a> is an ‘object storage’ service. More/less the same thing as AWS’ S3 (or Google Cloud’s cloud storage).</p>
<p><a href="https://www.terraform.io/">Terraform</a>, or its open source fork <a href="https://opentofu.org/">OpenTofu</a>, is a tool for managing declarations of cloud resources. There’s a <a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs">Terraform Provider for OpenStack</a>, so that Terraform can be used to work with OpenStack resources.</p>
<h2 id="task">Task</h2>
<p>Here are notes on using Terraform to manage an object in a ‘container’ on OpenStack Swift (‘bucket’ in AWS terms), and to create a (temporary) URL to access that object.</p>
<p>The main advantage of this approach is reyling on Terraform to manage the setup/teardown, as opposed to having to use the web console to manage this, or use the CLI client to manage these. I prefer being able to run <code>terraform apply</code> to ensure things are there; and <code>terraform destroy</code> to ensure things are gone.</p>
<h2 id="terraform-code-for-container-and-bucket">Terraform Code for Container and Bucket</h2>
<p>Some boilerplate, using the openstack provider for Terraform:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode terraform"><code class="sourceCode terraform"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">terraform</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">required_version</span> <span class="op">=</span> <span class="st">&quot;&gt;= 0.14.0&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">required_providers</span> {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    openstack <span class="op">=</span> {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">source</span>  <span class="op">=</span> <span class="st">&quot;terraform-provider-openstack/openstack&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      version <span class="op">=</span> <span class="st">&quot;~&gt; 1.49.0&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As the provider documentation mentions, the Terraform OpenStack provider can pick up authentication credentials from <code>OS_</code> environment variables. I used the Cleura public OpenStack cloud, and downloaded an ‘rc’ file with the credentials for an OpenStack user to use with a project there.</p>
<p>Then the Terraform code for creating a container <code>rgoulter-storage</code>, and an object named <code>test</code> in that container:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode terraform"><code class="sourceCode terraform"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">resource</span> <span class="st">&quot;openstack_objectstorage_container_v1&quot;</span> <span class="st">&quot;self&quot;</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  name <span class="op">=</span> <span class="st">&quot;rgoulter-storage&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  metadata <span class="op">=</span> {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    Temp<span class="op">-</span>URL<span class="op">-</span>Key <span class="op">=</span> <span class="st">&quot;some-secret-value&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="kw">resource</span> <span class="st">&quot;openstack_objectstorage_object_v1&quot;</span> <span class="st">&quot;self&quot;</span> {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  container_name <span class="op">=</span> openstack_objectstorage_container_v1.<span class="va">self</span>.name</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  name           <span class="op">=</span> <span class="st">&quot;test&quot;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">content</span>        <span class="op">=</span> <span class="st">&quot;Hello, world!&quot;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Resources are named <code>self</code> out of convention. (There aren’t multiple containers, objects in this Terraform codebase).</p>
<p>In this case, the content of the object is set with the <code>content</code> attribute to the object resource. The <code>source</code> attribute is more suitable when you want some file to be uploaded. (c.f. <a href="https://registry.terraform.io/providers/terraform-provider-openstack/openstack/latest/docs/resources/objectstorage_object_v1">the terraform provider documentation</a>).</p>
<p><code>Temp-URL-Key</code> is set on the container’s metadata to allow creating temporary URLs to provide access. (c.f. <a href="https://docs.openstack.org/swift/latest/api/temporary_url_middleware.html">Swift’s temporary url middleware documentation</a>). – This value should be kept secret; this value is used to create temporary URLs to access objects in the container.</p>
<h2 id="creating-temporary-urls-with-terraform">Creating Temporary URLs: with Terraform</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode terraform"><code class="sourceCode terraform"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">resource</span> <span class="st">&quot;openstack_objectstorage_tempurl_v1&quot;</span> <span class="st">&quot;self&quot;</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  container  <span class="op">=</span> openstack_objectstorage_container_v1.<span class="va">self</span>.name</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">object</span>     <span class="op">=</span> openstack_objectstorage_object_v1.<span class="va">self</span>.name</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  method     <span class="op">=</span> <span class="st">&quot;get&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  ttl        <span class="op">=</span> <span class="dv">900</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  regenerate <span class="op">=</span> <span class="va">true</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">output</span> <span class="st">&quot;tempurl&quot;</span> {</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  value     <span class="op">=</span> openstack_objectstorage_tempurl_v1.<span class="va">self</span>.url</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">sensitive</span> <span class="op">=</span> <span class="va">true</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>It’s possible to also use the Terraform OpenStack provider to manage tempurls.</p>
<p>On the one hand, you might as well, if you’re using Terraform for the other parts.
On the other hand, I think it smells a bit too much to ‘declare’ the existance of a tempurl with a time-to-live of 900 seconds.</p>
<p>One nice thing about this approach is the output URL value is simple/easy to figure out. i.e. running <code>terraform output -raw tempurl</code> outputs something like:</p>
<pre><code>https://swift-fra1.citycloud.com:8080/swift/v1/AUTH_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/rgoulter-storage/test?temp_url_sig=bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&amp;temp_url_expires=1999999999</code></pre>
<h2 id="creating-temporary-urls-with-command-line-client">Creating Temporary URLs: with Command Line Client</h2>
<p>The <a href="https://docs.openstack.org/swift/latest/api/temporary_url_middleware.html">documentation about temporary url middleware</a> gives instructions on using the OpenStack Swift client to create a temporary URL.</p>
<p>There are various ways to come up with the OpenStack Storage URL (<code>https://swift-cluster.example.com/v1/my_account/</code>), but here’s what I came up with for the container, object, and temp URL key above:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="va">OS_STORAGE_URL</span><span class="op">=</span><span class="va">$(</span><span class="ex">openstack</span> catalog show object-store <span class="at">--format</span><span class="op">=</span>json <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> .endpoints<span class="pp">[</span><span class="ss">2</span><span class="pp">]</span>.url<span class="va">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">swift</span> tempurl <span class="at">--digest</span><span class="op">=</span>sha1 GET 900 <span class="va">${OS_STORAGE_URL}</span>/rgoulter-storage/test some-secret-value</span></code></pre></div>
<p>The <code>jq</code> expression isn’t the cleanest. (The <code>[2]</code> is the index the “public” object-store endpoint happened to be in the output of <code>openstack catalog show object-store</code>; albeit, all the endpoints had the same URL).</p>
<p>The URL from <code>swift tempurl</code> can be used for GET requests to access the storage.</p>]]></summary>
</entry>

</feed>
